â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND                                â”‚
â”‚  User clicks "Show AI Suggestions" for Establishment 501234567  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HTTP REQUEST                                 â”‚
â”‚  GET /owner-sphere/b2b/501234567/suggestions                   â”‚
â”‚  Headers:                                                       â”‚
â”‚    - Authorization: Bearer <JWT_TOKEN>                         â”‚
â”‚    - Accept: application/json                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              âš™ï¸ LAYER 1: API CONTROLLER                         â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“„ File: B2BSuggestionsApiImpl.java                           â”‚
â”‚  ğŸ“ Location: osp-api/src/main/java/.../api/b2b/              â”‚
â”‚                                                                 â”‚
â”‚  âœ… What happens here:                                         â”‚
â”‚    1ï¸âƒ£ Log incoming request                                     â”‚
â”‚    2ï¸âƒ£ Extract regNo from path (501234567)                     â”‚
â”‚    3ï¸âƒ£ Get personId from JWT token (security context)          â”‚
â”‚    4ï¸âƒ£ Call service layer                                       â”‚
â”‚    5ï¸âƒ£ Handle null response defensively                         â”‚
â”‚    6ï¸âƒ£ Return ResponseEntity.ok(response)                       â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“ Code:                                                       â”‚
â”‚    SuggestionsResponse response =                              â”‚
â”‚        suggestionsService.getAiSuggestions(regNo, personId);  â”‚
â”‚    return ResponseEntity.ok(response);                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ğŸ§  LAYER 2: BUSINESS LOGIC / SERVICE                    â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“„ File: EstablishmentSuggestionsService.java                 â”‚
â”‚  ğŸ“ Location: ownersphere/src/main/java/.../service/          â”‚
â”‚                                                                 â”‚
â”‚  âœ… What happens here:                                         â”‚
â”‚    1ï¸âƒ£ Query database for OwnerSphereProfile                   â”‚
â”‚       â†³ SELECT * FROM T_OWNERSPHEREPROFILE                    â”‚
â”‚         WHERE ESTABLISHMENTID = regNo                          â”‚
â”‚                                                                 â”‚
â”‚    2ï¸âƒ£ Check if profile exists                                  â”‚
â”‚       â”œâ”€ âŒ NOT FOUND:                                         â”‚
â”‚       â”‚   â†³ Call AI directly (no tracking)                    â”‚
â”‚       â”‚   â†³ Return AI response                                â”‚
â”‚       â”‚                                                        â”‚
â”‚       â””â”€ âœ… FOUND:                                             â”‚
â”‚           â†³ Read profileData JSON column                      â”‚
â”‚           â†³ Check aiSuggestionsShown flag                     â”‚
â”‚                                                                 â”‚
â”‚    3ï¸âƒ£ Check if already shown                                   â”‚
â”‚       â”œâ”€ âœ… YES (aiSuggestionsShown = true):                  â”‚
â”‚       â”‚   â†³ Log "already shown"                               â”‚
â”‚       â”‚   â†³ Return empty list []                              â”‚
â”‚       â”‚   â†³ STOP (no AI call)                                 â”‚
â”‚       â”‚                                                        â”‚
â”‚       â””â”€ âŒ NO (aiSuggestionsShown = null/false):             â”‚
â”‚           â†³ Call AI proxy                                     â”‚
â”‚           â†³ Update flag: aiSuggestionsShown = true           â”‚
â”‚           â†³ Save date: aiSuggestionsFirstShownDate = today   â”‚
â”‚           â†³ Save to database                                  â”‚
â”‚           â†³ Return AI response                                â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“ Code Flow:                                                  â”‚
â”‚    if (profileData.getAiSuggestionsShown() == true) {         â”‚
â”‚        return emptyResponse();  // Cached behavior            â”‚
â”‚    }                                                           â”‚
â”‚    SuggestionsResponse ai = osbAiProxy.fetch(regNo);          â”‚
â”‚    profileData.setAiSuggestionsShown(true);                   â”‚
â”‚    repository.save(profile);                                   â”‚
â”‚    return ai;                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ğŸ”Œ LAYER 3: INTEGRATION / PROXY                       â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“„ File: OsbAiProxy.java                                      â”‚
â”‚  ğŸ“ Location: ownersphere/src/main/java/.../proxy/service/    â”‚
â”‚                                                                 â”‚
â”‚  âœ… What happens here:                                         â”‚
â”‚    1ï¸âƒ£ Generate UUID for request tracking                       â”‚
â”‚       â†³ requestId = UUID.randomUUID()                         â”‚
â”‚       â†³ Example: "cad7f12a-4096-47a9-a8f8-631d98685032"       â”‚
â”‚                                                                 â”‚
â”‚    2ï¸âƒ£ Prepare HTTP request                                     â”‚
â”‚       â†³ URL: apigeeBaseUrl + "/v1/gosi-brain/service-..."    â”‚
â”‚       â†³ Method: POST                                          â”‚
â”‚       â†³ Headers:                                               â”‚
â”‚         â€¢ Content-Type: application/json                      â”‚
â”‚         â€¢ X-Request-Id: {uuid}                                â”‚
â”‚       â†³ Body:                                                  â”‚
â”‚         {                                                      â”‚
â”‚           "registrationNumber": 501234567,                    â”‚
â”‚           "requestId": "uuid-here"                            â”‚
â”‚         }                                                      â”‚
â”‚                                                                 â”‚
â”‚    3ï¸âƒ£ Call Apigee AI service                                   â”‚
â”‚       â†³ restTemplate.exchange(url, POST, entity, ...)        â”‚
â”‚                                                                 â”‚
â”‚    4ï¸âƒ£ Handle response/errors                                   â”‚
â”‚       â”œâ”€ âœ… Success (200 OK):                                  â”‚
â”‚       â”‚   â†³ Deserialize JSON â†’ SuggestionsResponse           â”‚
â”‚       â”‚   â†³ Log success + count                               â”‚
â”‚       â”‚   â†³ Return response                                   â”‚
â”‚       â”‚                                                        â”‚
â”‚       â”œâ”€ âŒ Client Error (4xx):                                â”‚
â”‚       â”‚   â†³ throw OsbAiServiceException                       â”‚
â”‚       â”‚   â†³ includes requestId for tracking                   â”‚
â”‚       â”‚                                                        â”‚
â”‚       â”œâ”€ âŒ Server Error (5xx):                                â”‚
â”‚       â”‚   â†³ throw OsbAiServiceException                       â”‚
â”‚       â”‚                                                        â”‚
â”‚       â”œâ”€ âŒ Timeout/Network Error:                             â”‚
â”‚       â”‚   â†³ throw OsbAiServiceException                       â”‚
â”‚       â”‚                                                        â”‚
â”‚       â””â”€ âŒ Unexpected Error:                                  â”‚
â”‚           â†³ throw OsbAiServiceException                       â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“ Error Handling Code:                                        â”‚
â”‚    try {                                                       â”‚
â”‚        ResponseEntity<SuggestionsResponse> response =         â”‚
â”‚            restTemplate.exchange(...);                         â”‚
â”‚        return response.getBody();                              â”‚
â”‚    } catch (HttpClientErrorException e) {                     â”‚
â”‚        throw new OsbAiServiceException("Client error", e, id);â”‚
â”‚    } catch (HttpServerErrorException e) {                     â”‚
â”‚        throw new OsbAiServiceException("Server error", e, id);â”‚
â”‚    } catch (ResourceAccessException e) {                      â”‚
â”‚        throw new OsbAiServiceException("Timeout", e, id);     â”‚
â”‚    } catch (Exception e) {                                    â”‚
â”‚        throw new OsbAiServiceException("Unexpected", e, id);  â”‚
â”‚    }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ğŸŒ EXTERNAL: APIGEE GATEWAY                       â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“ Endpoint: POST /v1/gosi-brain/service-recommendation       â”‚
â”‚  ğŸ” Security: API Key (handled by OSB layer)                   â”‚
â”‚  ğŸ“Š Policies:                                                   â”‚
â”‚    âœ… API Key validation                                       â”‚
â”‚    âœ… Rate limiting                                            â”‚
â”‚    âœ… Request/Response transformation                          â”‚
â”‚    âœ… Logging & monitoring                                     â”‚
â”‚                                                                 â”‚
â”‚  âš™ï¸ Processing:                                                 â”‚
â”‚    1ï¸âƒ£ Validate API key                                         â”‚
â”‚    2ï¸âƒ£ Transform request if needed                              â”‚
â”‚    3ï¸âƒ£ Route to AI service backend                              â”‚
â”‚    4ï¸âƒ£ Transform response                                       â”‚
â”‚    5ï¸âƒ£ Add tracking headers                                     â”‚
â”‚    6ï¸âƒ£ Return to caller                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ğŸ¤– GOSI AI SERVICE (GOSI Brain)                    â”‚
â”‚                                                                 â”‚
â”‚  ğŸ§  AI Model processes:                                         â”‚
â”‚    â€¢ Registration number analysis                              â”‚
â”‚    â€¢ Business relationship patterns                            â”‚
â”‚    â€¢ Industry sector matching                                  â”‚
â”‚    â€¢ Geographic proximity                                      â”‚
â”‚    â€¢ Supply chain connections                                  â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“¤ Returns:                                                     â”‚
â”‚    {                                                            â”‚
â”‚      "establishments": [                                        â”‚
â”‚        {                                                        â”‚
â”‚          "establishmentName": "Ø´Ø±ÙƒØ© Ø§Ù„Ù†ÙˆØ± Ù„Ù„ØªØ¬Ø§Ø±Ø©",            â”‚
â”‚          "registrationNumber": 501111111,                      â”‚
â”‚          "establishmentLocation": "Riyadh",                    â”‚
â”‚          "unn": 7000000001,                                    â”‚
â”‚          "aiConfidenceScore": 0.95,                            â”‚
â”‚          "matchReason": "Similar business activity"            â”‚
â”‚        },                                                       â”‚
â”‚        ...                                                      â”‚
â”‚      ]                                                          â”‚
â”‚    }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â¬…ï¸ RESPONSE FLOWS BACK                        â”‚
â”‚                                                                 â”‚
â”‚  AI Service â†’ Apigee â†’ OsbAiProxy â†’ Service â†’ Controller      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ğŸ’¾ DATABASE UPDATE (if first time)                 â”‚
â”‚                                                                 â”‚
â”‚  UPDATE T_OWNERSPHEREPROFILE                                   â”‚
â”‚  SET PROFILEDATA = '{                                           â”‚
â”‚    "aiSuggestionsShown": true,                                 â”‚
â”‚    "aiSuggestionsFirstShownDate": "2025-10-29",               â”‚
â”‚    ...other fields                                             â”‚
â”‚  }'                                                             â”‚
â”‚  WHERE PROFILEID = ...                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ğŸ“¡ HTTP RESPONSE TO FRONTEND                   â”‚
â”‚                                                                 â”‚
â”‚  Status: 200 OK                                                â”‚
â”‚  Content-Type: application/json                                â”‚
â”‚                                                                 â”‚
â”‚  Body:                                                          â”‚
â”‚  {                                                              â”‚
â”‚    "establishments": [                                          â”‚
â”‚      {                                                          â”‚
â”‚        "establishmentName": "Ø´Ø±ÙƒØ© Ø§Ù„Ù†ÙˆØ± Ù„Ù„ØªØ¬Ø§Ø±Ø©",              â”‚
â”‚        "registrationNumber": 501111111,                        â”‚
â”‚        "establishmentLocation": "Riyadh",                      â”‚
â”‚        "unn": 7000000001                                       â”‚
â”‚      },                                                         â”‚
â”‚      {                                                          â”‚
â”‚        "establishmentName": "Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø£Ù…Ù„",                      â”‚
â”‚        "registrationNumber": 501222222,                        â”‚
â”‚        "establishmentLocation": "Jeddah",                      â”‚
â”‚        "unn": 7000000002                                       â”‚
â”‚      }                                                          â”‚
â”‚    ]                                                            â”‚
â”‚  }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND DISPLAY                         â”‚
â”‚  User sees list of suggested establishments                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
