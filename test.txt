# 📊 B2B AI Suggestions - مقارنة بين المطلوب والمنفذ

## 🎯 ملخص التنفيذ

### ✅ اللي اتعمل بناءً على الـ Spec
### ⚠️ اللي اتعمل اجتهاد (محتاج تأكيد)
### ❌ اللي ناقص

---

## 1️⃣ API Endpoint

### ✅ **المطلوب من الـ Spec:**
```
Method: GET
Endpoint: /owner-sphere/b2b/{regNo}/suggestions
Path Parameter: regNo (establishment registration number)
Headers: 
  - Authorization: Bearer <token>
  - x-apikey: <apikey>
  - Content-Type: application/json
```

### ✅ **اللي اتعمل:**
```java
// File: B2BSuggestionsApi.java
@GetMapping("/{regNo}/suggestions")
ResponseEntity<SuggestionsResponse> getSuggestions(@PathVariable("regNo") Long regNo);

// File: B2BSuggestionsApiImpl.java
@RequestMapping(value = "/owner-sphere/b2b")
```

**✅ Status: مطابق 100%**

---

## 2️⃣ Response Body Structure

### ✅ **المطلوب من الـ Spec:**
```json
{
   "establishments":[
      {
         "establishmentName":"string",
         "establishmentLocation":"string",
         "startDate":{
            "entryFormat":"GREGORIAN",
            "gregorian":"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'",
            "hijiri":"yyyy-MM-dd"
         },
         "unn":0,
         "registrationNumber":0,
         "suggestionReason":{
            "arabic":"string",
            "english":"string"
         }
      }
   ]
}
```

### ✅ **اللي اتعمل:**
```java
// SuggestionsResponse.java
public class SuggestionsResponse {
    private List<EstablishmentSuggestion> establishments; ✅
}

// EstablishmentSuggestion.java
public class EstablishmentSuggestion {
    private String establishmentName;           ✅
    private String establishmentLocation;       ✅
    private DateInfo startDate;                 ✅
    private Long unn;                           ✅
    private Long registrationNumber;            ✅
    private BilingualText suggestionReason;     ✅
}

// DateInfo.java
public class DateInfo {
    private String entryFormat;   ✅
    private String gregorian;     ✅
    private String hijiri;        ✅
}
```

**✅ Status: مطابق 100%**

---

## 3️⃣ Data Types - تحتاج تأكيد

### ⚠️ **اجتهاد مني (محتاج تأكيد من AI Team):**

| Field | اللي عملته | محتاج تتأكد |
|-------|-----------|-------------|
| `unn` | `Long` | هل هو `Long` ولا `String`? |
| `registrationNumber` | `Long` | هل هو `Long` ولا `String`? |
| `startDate.gregorian` | `String` | الـ format بالظبط: `yyyy-MM-dd'T'HH:mm:ss.SSS'Z'`? |
| `startDate.hijiri` | `String` | الـ format بالظبط: `yyyy-MM-dd`? |

**⚠️ Action Required:** اسأل الـ AI Team عن:
1. Sample response فعلي من الـ AI
2. الـ data types الصح
3. الـ date formats بالظبط

---

## 4️⃣ Business Logic - "Show Once"

### ⚠️ **المطلوب (مش مذكور في الـ Spec بالظبط):**
الـ Spec مقالش حاجة عن "show once per establishment" - ده كان من كلامك في أول المحادثة.

### ✅ **اللي اتعمل:**
```java
// EstablishmentSuggestionsService.java
public SuggestionsResponse getAiSuggestions(Long registrationNo, Long personId) {
    // 1. Check profileData JSON for aiSuggestionsShown flag
    if (profileData.getAiSuggestionsShown() == true) {
        return empty list; // Already shown before
    }
    
    // 2. First time - call AI
    SuggestionsResponse aiResponse = osbAiProxy.fetchAiSuggestions(regNo);
    
    // 3. Update flag in JSON
    profileData.setAiSuggestionsShown(true);
    profileData.setAiSuggestionsFirstShownDate(LocalDate.now().toString());
    
    return aiResponse;
}
```

### ⚠️ **محتاج تتأكد:**
1. هل فعلاً المطلوب "show once per establishment"?
2. ولا المطلوب "show once per owner + establishment"?
3. لو اتعرضت للـ owner A، وجه owner B يشوفها؟

**⚠️ Action Required:** تأكد من الـ business rule بالظبط

---

## 5️⃣ AI Call - إذا فشل

### ✅ **المطلوب من الـ Spec:**
> "What will happen if the AI call fails?"

### ✅ **اللي اتعمل:**
```java
// OsbAiProxy.java
public SuggestionsResponse fetchAiSuggestions(Long registrationNo) {
    try {
        // Call AI via Apigee
        return restTemplate.exchange(...);
        
    } catch (HttpClientErrorException | HttpServerErrorException | 
             ResourceAccessException e) {
        log.error("AI service failed", e);
        
        // Graceful degradation - return empty list
        return SuggestionsResponse.builder()
            .establishments(Collections.emptyList())
            .build();
    }
}
```

**✅ Status: منفذ - لكن محتاج تتأكد:**
- هل المطلوب empty list؟
- ولا المطلوب error response (400/500)?
- ولا المطلوب cached data?

---

## 6️⃣ Apigee Infrastructure

### ✅ **المطلوب من الـ Spec:**
```
1. Create Apigee Proxy #1: v1/owner-sphere/b2b/{regNo}/suggestions → Owner Sphere backend
2. Create Developer App + API Product
3. Create Apigee Proxy #2: OWS → OSB → AI
4. Create KVM
```

### ✅ **اللي اتعمل:**
| Task | Status | Details |
|------|--------|---------|
| Proxy #1 | ✅ Done | `/v1/owner-sphere/b2b` → OWS backend |
| Developer App | ✅ Done | API Key: `LLrquEpkhNG2O3E19H36Rp0wNlY4rj8s` |
| API Product | ✅ Done | `owner-sphere-b2b-product` |
| Proxy #2 | ❌ Pending | محتاج AI endpoint URL |
| KVM | ⏳ Optional | يفضل للـ production |

---

## 7️⃣ اللي اتعمل اجتهاد (TODO List)

### ⚠️ **Backend Code - محتاج بيانات فعلية:**

#### 1. **OsbAiProxy.java** - URL & Headers
```java
// Line ~70 - PLACEHOLDER
String url = apiBaseUrl + "/TODO_APIGEE_PROXY_PATH" + "?regNo=" + registrationNo;

// Line ~75 - PLACEHOLDER
headers.set("TODO_API_KEY_HEADER_NAME", apiKey);
```

**⚠️ محتاج تحدد:**
- [ ] ما هو الـ path بتاع Apigee Proxy #2 بالظبط؟
- [ ] اسم الـ header للـ API key: `x-apikey` أم `apikey` أم `Authorization`؟
- [ ] هل في headers تانية محتاجة (مثل `request-id`, `correlation-id`)?

---

#### 2. **B2BSuggestionsApiImpl.java** - PersonId Extraction
```java
// Line ~70 - PLACEHOLDER
private Long getCurrentPersonId() {
    return 1L; // TODO: Extract from JWT
}
```

**⚠️ محتاج تحدد:**
- [ ] ما هو الـ claim name للـ personId في الـ JWT؟
- [ ] كيف تستخرجه من `SecurityContextHolder`?
- [ ] هل هو `Long` أم `String`?

**⚠️ اسأل Security Team**

---

#### 3. **OwnerProfileData.java** - JSON Fields
```java
// Added fields (اجتهاد)
private Boolean aiSuggestionsShown;
private String aiSuggestionsFirstShownDate;
```

**⚠️ محتاج تتأكد:**
- [ ] هل فعلاً يتخزن في الـ JSON `profileData`?
- [ ] ولا يفضل أعمدة منفصلة في الجدول؟
- [ ] هل الـ date format `String` ISO مناسب ولا `LocalDate`?

---

#### 4. **EstablishmentSuggestion.java** - suggestionReason
```java
private BilingualText suggestionReason; // WHO populates this?
```

**⚠️ محتاج تتأكد:**
- [ ] مين اللي يملأ الـ `suggestionReason`؟
  - الـ AI service نفسه؟
  - ولا الـ backend بتاعك؟
- [ ] لو الـ backend، إيه اللوجيك؟

**⚠️ اسأل AI Team**

---

#### 5. **application.properties** - Configuration
```properties
# Current values (اجتهاد)
api.base.url=https://apigee.gosi.sa
app.apikey=LLrquEpkhNG2O3E19H36Rp0wNlY4rj8s
osb.ai.timeout=10000
```

**⚠️ محتاج تتأكد:**
- [ ] هل الـ `api.base.url` صح؟
- [ ] هل الـ timeout 10 seconds مناسب؟
- [ ] هل في configs تانية محتاجة؟

---

## 8️⃣ Error Responses - مش منفذة

### ❌ **المطلوب من الـ Spec:**
```json
400 Bad Request:
{
  "code": "string",
  "message": {
    "arabic": "string",
    "english": "string"
  },
  "status": "string",
  "timeStamp": "yyyy-MM-dd'T'hh:mm:ss.s'Z'"
}

422 Unprocessable Entity:
{
  "code": "string",
  "details": [
    {
      "code": "string",
      "message": {
        "arabic": "string",
        "english": "string"
      }
    }
  ],
  "message": {
    "arabic": "string",
    "english": "string"
  },
  "status": "string",
  "timeStamp": "yyyy-MM-dd'T'hh:mm:ss.s'Z'"
}
```

### ❌ **اللي اتعمل:**
مفيش error handling مخصص - بيستخدم الـ default Spring error handling

**❌ Action Required:**
- [ ] هل محتاج custom error DTOs؟
- [ ] ولا الـ framework error handling كافي؟
- [ ] محتاج exception handlers?

---

## 9️⃣ Database Schema

### ⚠️ **اللي اتعمل (اجتهاد):**
```java
// OwnerSphereProfileEntity.java
// Uses existing column: PROFILEDATA (JSON)
// Stores inside JSON:
{
  "profilePicURL": "...",
  "aiSuggestionsShown": true,
  "aiSuggestionsFirstShownDate": "2025-10-27"
}
```

**⚠️ محتاج تتأكد:**
- [ ] هل الـ JSON approach مناسب؟
- [ ] ولا تفضل أعمدة منفصلة؟
- [ ] محتاج DBA approval?

**Alternatives:**
1. ✅ **Current:** JSON في column موجود (no schema change)
2. ❌ **Alternative:** Add columns `AI_SUGGESTIONS_SHOWN`, `AI_SUGGESTIONS_FIRST_SHOWN_DATE`

---

## 🔟 Repository Query

### ⚠️ **اللي اتعمل (اجتهاد):**
```java
// OwnerSphereProfileRepository.java
@Query("SELECT p FROM OwnerSphereProfileEntity p " +
       "JOIN p.establishment e " +
       "WHERE e.registrationNo = :registrationNo")
Optional<OwnerSphereProfileEntity> findByEstablishmentRegistrationNo(Long registrationNo);
```

**⚠️ محتاج تتأكد:**
- [ ] هل الـ query صح؟
- [ ] هل في performance concerns?
- [ ] محتاج index على `registrationNo`?

---

## 📋 خلاصة: اللي محتاج تسأل عنه

### 🔴 **Priority 1 - Critical (بيوقف الشغل):**

#### 1. من **AI Team:**
```
Subject: AI Service Details for B2B Suggestions

Questions:
1. What is the AI endpoint URL? (full path)
2. Sample JSON response from AI?
3. Data types: is unn Long or String? registrationNumber?
4. Who populates suggestionReason? AI or backend?
5. Date format for gregorian and hijiri?
6. Expected response time (timeout)?
```

#### 2. من **Apigee/OSB Team:**
```
Subject: Apigee Proxy #2 Configuration

Questions:
1. What is the Proxy #2 base path?
2. API key header name: x-apikey or apikey or Authorization?
3. Any other required headers (request-id, correlation-id)?
4. Query parameter format for regNo?
5. OSB routing configuration?
```

#### 3. من **Security Team:**
```
Subject: JWT PersonId Extraction

Questions:
1. JWT claim name for personId?
2. Data type: Long or String?
3. How to extract from SecurityContextHolder?
4. Code example?
```

---

### 🟡 **Priority 2 - Important (محتاج قرار):**

#### 4. من **Product Owner/Business:**
```
Subject: B2B Suggestions Business Rules

Questions:
1. "Show once" means:
   - Once per establishment (any owner)?
   - Once per owner + establishment?
2. If AI fails, should we:
   - Return empty list (current)?
   - Return error response?
   - Use cached data?
3. Do we need custom error responses (400/422/500)?
```

#### 5. من **DBA/Lead:**
```
Subject: Database Schema for AI Suggestions Tracking

Questions:
1. Store in JSON (current approach) or add columns?
2. Performance concerns?
3. Need index on registrationNo?
```

---

### 🟢 **Priority 3 - Nice to Have:**

#### 6. من **DevOps:**
```
Questions:
1. KVM setup in dev/test/prod?
2. API key rotation policy?
3. Monitoring/alerting setup?
```

---

## 📊 الملف النهائي للمقارنة

| Component | Status | Notes |
|-----------|--------|-------|
| **API Interface** | ✅ Done | Matches spec 100% |
| **API Implementation** | ⚠️ 90% | Missing: JWT extraction |
| **DTOs** | ✅ Done | Matches spec structure |
| **Service Logic** | ⚠️ 80% | Need to confirm business rule |
| **AI Proxy** | ⚠️ 50% | Placeholders for URL/headers |
| **Database** | ⚠️ Done | Using JSON (need confirmation) |
| **Error Handling** | ⚠️ Basic | AI failure returns empty list |
| **Apigee Proxy #1** | ✅ Done | UI → OWS |
| **Apigee Proxy #2** | ❌ Pending | Need AI endpoint |
| **Developer App** | ✅ Done | API Key created |
| **KVM** | ⏳ Optional | For production |

---

## ✅ الخطوات التالية

### هذا الأسبوع:
1. ✉️ Send emails to AI Team, Security Team, Apigee Team
2. 📞 Get answers for all placeholder TODOs
3. 🔧 Update code with real values
4. 🧪 Test with actual AI endpoint

### الأسبوع الجاي:
5. 🏗️ Create Apigee Proxy #2
6. 🔐 Setup KVM (optional)
7. ✅ End-to-end testing
8. 📝 Update documentation

---

**تاريخ المراجعة:** 27 أكتوبر 2025  
**الحالة:** 70% مكتمل - محتاج بيانات فعلية من الفرق الأخرى
