# ğŸ“Š B2B AI Suggestions - Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙˆØ§Ù„Ù…Ù†ÙØ°

## ğŸ¯ Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ†ÙÙŠØ°

### âœ… Ø§Ù„Ù„ÙŠ Ø§ØªØ¹Ù…Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù€ Spec
### âš ï¸ Ø§Ù„Ù„ÙŠ Ø§ØªØ¹Ù…Ù„ Ø§Ø¬ØªÙ‡Ø§Ø¯ (Ù…Ø­ØªØ§Ø¬ ØªØ£ÙƒÙŠØ¯)
### âŒ Ø§Ù„Ù„ÙŠ Ù†Ø§Ù‚Øµ

---

## 1ï¸âƒ£ API Endpoint

### âœ… **Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ù€ Spec:**
```
Method: GET
Endpoint: /owner-sphere/b2b/{regNo}/suggestions
Path Parameter: regNo (establishment registration number)
Headers: 
  - Authorization: Bearer <token>
  - x-apikey: <apikey>
  - Content-Type: application/json
```

### âœ… **Ø§Ù„Ù„ÙŠ Ø§ØªØ¹Ù…Ù„:**
```java
// File: B2BSuggestionsApi.java
@GetMapping("/{regNo}/suggestions")
ResponseEntity<SuggestionsResponse> getSuggestions(@PathVariable("regNo") Long regNo);

// File: B2BSuggestionsApiImpl.java
@RequestMapping(value = "/owner-sphere/b2b")
```

**âœ… Status: Ù…Ø·Ø§Ø¨Ù‚ 100%**

---

## 2ï¸âƒ£ Response Body Structure

### âœ… **Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ù€ Spec:**
```json
{
   "establishments":[
      {
         "establishmentName":"string",
         "establishmentLocation":"string",
         "startDate":{
            "entryFormat":"GREGORIAN",
            "gregorian":"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'",
            "hijiri":"yyyy-MM-dd"
         },
         "unn":0,
         "registrationNumber":0,
         "suggestionReason":{
            "arabic":"string",
            "english":"string"
         }
      }
   ]
}
```

### âœ… **Ø§Ù„Ù„ÙŠ Ø§ØªØ¹Ù…Ù„:**
```java
// SuggestionsResponse.java
public class SuggestionsResponse {
    private List<EstablishmentSuggestion> establishments; âœ…
}

// EstablishmentSuggestion.java
public class EstablishmentSuggestion {
    private String establishmentName;           âœ…
    private String establishmentLocation;       âœ…
    private DateInfo startDate;                 âœ…
    private Long unn;                           âœ…
    private Long registrationNumber;            âœ…
    private BilingualText suggestionReason;     âœ…
}

// DateInfo.java
public class DateInfo {
    private String entryFormat;   âœ…
    private String gregorian;     âœ…
    private String hijiri;        âœ…
}
```

**âœ… Status: Ù…Ø·Ø§Ø¨Ù‚ 100%**

---

## 3ï¸âƒ£ Data Types - ØªØ­ØªØ§Ø¬ ØªØ£ÙƒÙŠØ¯

### âš ï¸ **Ø§Ø¬ØªÙ‡Ø§Ø¯ Ù…Ù†ÙŠ (Ù…Ø­ØªØ§Ø¬ ØªØ£ÙƒÙŠØ¯ Ù…Ù† AI Team):**

| Field | Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„ØªÙ‡ | Ù…Ø­ØªØ§Ø¬ ØªØªØ£ÙƒØ¯ |
|-------|-----------|-------------|
| `unn` | `Long` | Ù‡Ù„ Ù‡Ùˆ `Long` ÙˆÙ„Ø§ `String`? |
| `registrationNumber` | `Long` | Ù‡Ù„ Ù‡Ùˆ `Long` ÙˆÙ„Ø§ `String`? |
| `startDate.gregorian` | `String` | Ø§Ù„Ù€ format Ø¨Ø§Ù„Ø¸Ø¨Ø·: `yyyy-MM-dd'T'HH:mm:ss.SSS'Z'`? |
| `startDate.hijiri` | `String` | Ø§Ù„Ù€ format Ø¨Ø§Ù„Ø¸Ø¨Ø·: `yyyy-MM-dd`? |

**âš ï¸ Action Required:** Ø§Ø³Ø£Ù„ Ø§Ù„Ù€ AI Team Ø¹Ù†:
1. Sample response ÙØ¹Ù„ÙŠ Ù…Ù† Ø§Ù„Ù€ AI
2. Ø§Ù„Ù€ data types Ø§Ù„ØµØ­
3. Ø§Ù„Ù€ date formats Ø¨Ø§Ù„Ø¸Ø¨Ø·

---

## 4ï¸âƒ£ Business Logic - "Show Once"

### âš ï¸ **Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ù…Ø´ Ù…Ø°ÙƒÙˆØ± ÙÙŠ Ø§Ù„Ù€ Spec Ø¨Ø§Ù„Ø¸Ø¨Ø·):**
Ø§Ù„Ù€ Spec Ù…Ù‚Ø§Ù„Ø´ Ø­Ø§Ø¬Ø© Ø¹Ù† "show once per establishment" - Ø¯Ù‡ ÙƒØ§Ù† Ù…Ù† ÙƒÙ„Ø§Ù…Ùƒ ÙÙŠ Ø£ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.

### âœ… **Ø§Ù„Ù„ÙŠ Ø§ØªØ¹Ù…Ù„:**
```java
// EstablishmentSuggestionsService.java
public SuggestionsResponse getAiSuggestions(Long registrationNo, Long personId) {
    // 1. Check profileData JSON for aiSuggestionsShown flag
    if (profileData.getAiSuggestionsShown() == true) {
        return empty list; // Already shown before
    }
    
    // 2. First time - call AI
    SuggestionsResponse aiResponse = osbAiProxy.fetchAiSuggestions(regNo);
    
    // 3. Update flag in JSON
    profileData.setAiSuggestionsShown(true);
    profileData.setAiSuggestionsFirstShownDate(LocalDate.now().toString());
    
    return aiResponse;
}
```

### âš ï¸ **Ù…Ø­ØªØ§Ø¬ ØªØªØ£ÙƒØ¯:**
1. Ù‡Ù„ ÙØ¹Ù„Ø§Ù‹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ "show once per establishment"?
2. ÙˆÙ„Ø§ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ "show once per owner + establishment"?
3. Ù„Ùˆ Ø§ØªØ¹Ø±Ø¶Øª Ù„Ù„Ù€ owner AØŒ ÙˆØ¬Ù‡ owner B ÙŠØ´ÙˆÙÙ‡Ø§ØŸ

**âš ï¸ Action Required:** ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù€ business rule Ø¨Ø§Ù„Ø¸Ø¨Ø·

---

## 5ï¸âƒ£ AI Call - Ø¥Ø°Ø§ ÙØ´Ù„

### âœ… **Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ù€ Spec:**
> "What will happen if the AI call fails?"

### âœ… **Ø§Ù„Ù„ÙŠ Ø§ØªØ¹Ù…Ù„:**
```java
// OsbAiProxy.java
public SuggestionsResponse fetchAiSuggestions(Long registrationNo) {
    try {
        // Call AI via Apigee
        return restTemplate.exchange(...);
        
    } catch (HttpClientErrorException | HttpServerErrorException | 
             ResourceAccessException e) {
        log.error("AI service failed", e);
        
        // Graceful degradation - return empty list
        return SuggestionsResponse.builder()
            .establishments(Collections.emptyList())
            .build();
    }
}
```

**âœ… Status: Ù…Ù†ÙØ° - Ù„ÙƒÙ† Ù…Ø­ØªØ§Ø¬ ØªØªØ£ÙƒØ¯:**
- Ù‡Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ empty listØŸ
- ÙˆÙ„Ø§ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ error response (400/500)?
- ÙˆÙ„Ø§ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ cached data?

---

## 6ï¸âƒ£ Apigee Infrastructure

### âœ… **Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ù€ Spec:**
```
1. Create Apigee Proxy #1: v1/owner-sphere/b2b/{regNo}/suggestions â†’ Owner Sphere backend
2. Create Developer App + API Product
3. Create Apigee Proxy #2: OWS â†’ OSB â†’ AI
4. Create KVM
```

### âœ… **Ø§Ù„Ù„ÙŠ Ø§ØªØ¹Ù…Ù„:**
| Task | Status | Details |
|------|--------|---------|
| Proxy #1 | âœ… Done | `/v1/owner-sphere/b2b` â†’ OWS backend |
| Developer App | âœ… Done | API Key: `LLrquEpkhNG2O3E19H36Rp0wNlY4rj8s` |
| API Product | âœ… Done | `owner-sphere-b2b-product` |
| Proxy #2 | âŒ Pending | Ù…Ø­ØªØ§Ø¬ AI endpoint URL |
| KVM | â³ Optional | ÙŠÙØ¶Ù„ Ù„Ù„Ù€ production |

---

## 7ï¸âƒ£ Ø§Ù„Ù„ÙŠ Ø§ØªØ¹Ù…Ù„ Ø§Ø¬ØªÙ‡Ø§Ø¯ (TODO List)

### âš ï¸ **Backend Code - Ù…Ø­ØªØ§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ¹Ù„ÙŠØ©:**

#### 1. **OsbAiProxy.java** - URL & Headers
```java
// Line ~70 - PLACEHOLDER
String url = apiBaseUrl + "/TODO_APIGEE_PROXY_PATH" + "?regNo=" + registrationNo;

// Line ~75 - PLACEHOLDER
headers.set("TODO_API_KEY_HEADER_NAME", apiKey);
```

**âš ï¸ Ù…Ø­ØªØ§Ø¬ ØªØ­Ø¯Ø¯:**
- [ ] Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù€ path Ø¨ØªØ§Ø¹ Apigee Proxy #2 Ø¨Ø§Ù„Ø¸Ø¨Ø·ØŸ
- [ ] Ø§Ø³Ù… Ø§Ù„Ù€ header Ù„Ù„Ù€ API key: `x-apikey` Ø£Ù… `apikey` Ø£Ù… `Authorization`ØŸ
- [ ] Ù‡Ù„ ÙÙŠ headers ØªØ§Ù†ÙŠØ© Ù…Ø­ØªØ§Ø¬Ø© (Ù…Ø«Ù„ `request-id`, `correlation-id`)?

---

#### 2. **B2BSuggestionsApiImpl.java** - PersonId Extraction
```java
// Line ~70 - PLACEHOLDER
private Long getCurrentPersonId() {
    return 1L; // TODO: Extract from JWT
}
```

**âš ï¸ Ù…Ø­ØªØ§Ø¬ ØªØ­Ø¯Ø¯:**
- [ ] Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù€ claim name Ù„Ù„Ù€ personId ÙÙŠ Ø§Ù„Ù€ JWTØŸ
- [ ] ÙƒÙŠÙ ØªØ³ØªØ®Ø±Ø¬Ù‡ Ù…Ù† `SecurityContextHolder`?
- [ ] Ù‡Ù„ Ù‡Ùˆ `Long` Ø£Ù… `String`?

**âš ï¸ Ø§Ø³Ø£Ù„ Security Team**

---

#### 3. **OwnerProfileData.java** - JSON Fields
```java
// Added fields (Ø§Ø¬ØªÙ‡Ø§Ø¯)
private Boolean aiSuggestionsShown;
private String aiSuggestionsFirstShownDate;
```

**âš ï¸ Ù…Ø­ØªØ§Ø¬ ØªØªØ£ÙƒØ¯:**
- [ ] Ù‡Ù„ ÙØ¹Ù„Ø§Ù‹ ÙŠØªØ®Ø²Ù† ÙÙŠ Ø§Ù„Ù€ JSON `profileData`?
- [ ] ÙˆÙ„Ø§ ÙŠÙØ¶Ù„ Ø£Ø¹Ù…Ø¯Ø© Ù…Ù†ÙØµÙ„Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŸ
- [ ] Ù‡Ù„ Ø§Ù„Ù€ date format `String` ISO Ù…Ù†Ø§Ø³Ø¨ ÙˆÙ„Ø§ `LocalDate`?

---

#### 4. **EstablishmentSuggestion.java** - suggestionReason
```java
private BilingualText suggestionReason; // WHO populates this?
```

**âš ï¸ Ù…Ø­ØªØ§Ø¬ ØªØªØ£ÙƒØ¯:**
- [ ] Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ ÙŠÙ…Ù„Ø£ Ø§Ù„Ù€ `suggestionReason`ØŸ
  - Ø§Ù„Ù€ AI service Ù†ÙØ³Ù‡ØŸ
  - ÙˆÙ„Ø§ Ø§Ù„Ù€ backend Ø¨ØªØ§Ø¹ÙƒØŸ
- [ ] Ù„Ùˆ Ø§Ù„Ù€ backendØŒ Ø¥ÙŠÙ‡ Ø§Ù„Ù„ÙˆØ¬ÙŠÙƒØŸ

**âš ï¸ Ø§Ø³Ø£Ù„ AI Team**

---

#### 5. **application.properties** - Configuration
```properties
# Current values (Ø§Ø¬ØªÙ‡Ø§Ø¯)
api.base.url=https://apigee.gosi.sa
app.apikey=LLrquEpkhNG2O3E19H36Rp0wNlY4rj8s
osb.ai.timeout=10000
```

**âš ï¸ Ù…Ø­ØªØ§Ø¬ ØªØªØ£ÙƒØ¯:**
- [ ] Ù‡Ù„ Ø§Ù„Ù€ `api.base.url` ØµØ­ØŸ
- [ ] Ù‡Ù„ Ø§Ù„Ù€ timeout 10 seconds Ù…Ù†Ø§Ø³Ø¨ØŸ
- [ ] Ù‡Ù„ ÙÙŠ configs ØªØ§Ù†ÙŠØ© Ù…Ø­ØªØ§Ø¬Ø©ØŸ

---

## 8ï¸âƒ£ Error Responses - Ù…Ø´ Ù…Ù†ÙØ°Ø©

### âŒ **Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ù€ Spec:**
```json
400 Bad Request:
{
  "code": "string",
  "message": {
    "arabic": "string",
    "english": "string"
  },
  "status": "string",
  "timeStamp": "yyyy-MM-dd'T'hh:mm:ss.s'Z'"
}

422 Unprocessable Entity:
{
  "code": "string",
  "details": [
    {
      "code": "string",
      "message": {
        "arabic": "string",
        "english": "string"
      }
    }
  ],
  "message": {
    "arabic": "string",
    "english": "string"
  },
  "status": "string",
  "timeStamp": "yyyy-MM-dd'T'hh:mm:ss.s'Z'"
}
```

### âŒ **Ø§Ù„Ù„ÙŠ Ø§ØªØ¹Ù…Ù„:**
Ù…ÙÙŠØ´ error handling Ù…Ø®ØµØµ - Ø¨ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù€ default Spring error handling

**âŒ Action Required:**
- [ ] Ù‡Ù„ Ù…Ø­ØªØ§Ø¬ custom error DTOsØŸ
- [ ] ÙˆÙ„Ø§ Ø§Ù„Ù€ framework error handling ÙƒØ§ÙÙŠØŸ
- [ ] Ù…Ø­ØªØ§Ø¬ exception handlers?

---

## 9ï¸âƒ£ Database Schema

### âš ï¸ **Ø§Ù„Ù„ÙŠ Ø§ØªØ¹Ù…Ù„ (Ø§Ø¬ØªÙ‡Ø§Ø¯):**
```java
// OwnerSphereProfileEntity.java
// Uses existing column: PROFILEDATA (JSON)
// Stores inside JSON:
{
  "profilePicURL": "...",
  "aiSuggestionsShown": true,
  "aiSuggestionsFirstShownDate": "2025-10-27"
}
```

**âš ï¸ Ù…Ø­ØªØ§Ø¬ ØªØªØ£ÙƒØ¯:**
- [ ] Ù‡Ù„ Ø§Ù„Ù€ JSON approach Ù…Ù†Ø§Ø³Ø¨ØŸ
- [ ] ÙˆÙ„Ø§ ØªÙØ¶Ù„ Ø£Ø¹Ù…Ø¯Ø© Ù…Ù†ÙØµÙ„Ø©ØŸ
- [ ] Ù…Ø­ØªØ§Ø¬ DBA approval?

**Alternatives:**
1. âœ… **Current:** JSON ÙÙŠ column Ù…ÙˆØ¬ÙˆØ¯ (no schema change)
2. âŒ **Alternative:** Add columns `AI_SUGGESTIONS_SHOWN`, `AI_SUGGESTIONS_FIRST_SHOWN_DATE`

---

## ğŸ”Ÿ Repository Query

### âš ï¸ **Ø§Ù„Ù„ÙŠ Ø§ØªØ¹Ù…Ù„ (Ø§Ø¬ØªÙ‡Ø§Ø¯):**
```java
// OwnerSphereProfileRepository.java
@Query("SELECT p FROM OwnerSphereProfileEntity p " +
       "JOIN p.establishment e " +
       "WHERE e.registrationNo = :registrationNo")
Optional<OwnerSphereProfileEntity> findByEstablishmentRegistrationNo(Long registrationNo);
```

**âš ï¸ Ù…Ø­ØªØ§Ø¬ ØªØªØ£ÙƒØ¯:**
- [ ] Ù‡Ù„ Ø§Ù„Ù€ query ØµØ­ØŸ
- [ ] Ù‡Ù„ ÙÙŠ performance concerns?
- [ ] Ù…Ø­ØªØ§Ø¬ index Ø¹Ù„Ù‰ `registrationNo`?

---

## ğŸ“‹ Ø®Ù„Ø§ØµØ©: Ø§Ù„Ù„ÙŠ Ù…Ø­ØªØ§Ø¬ ØªØ³Ø£Ù„ Ø¹Ù†Ù‡

### ğŸ”´ **Priority 1 - Critical (Ø¨ÙŠÙˆÙ‚Ù Ø§Ù„Ø´ØºÙ„):**

#### 1. Ù…Ù† **AI Team:**
```
Subject: AI Service Details for B2B Suggestions

Questions:
1. What is the AI endpoint URL? (full path)
2. Sample JSON response from AI?
3. Data types: is unn Long or String? registrationNumber?
4. Who populates suggestionReason? AI or backend?
5. Date format for gregorian and hijiri?
6. Expected response time (timeout)?
```

#### 2. Ù…Ù† **Apigee/OSB Team:**
```
Subject: Apigee Proxy #2 Configuration

Questions:
1. What is the Proxy #2 base path?
2. API key header name: x-apikey or apikey or Authorization?
3. Any other required headers (request-id, correlation-id)?
4. Query parameter format for regNo?
5. OSB routing configuration?
```

#### 3. Ù…Ù† **Security Team:**
```
Subject: JWT PersonId Extraction

Questions:
1. JWT claim name for personId?
2. Data type: Long or String?
3. How to extract from SecurityContextHolder?
4. Code example?
```

---

### ğŸŸ¡ **Priority 2 - Important (Ù…Ø­ØªØ§Ø¬ Ù‚Ø±Ø§Ø±):**

#### 4. Ù…Ù† **Product Owner/Business:**
```
Subject: B2B Suggestions Business Rules

Questions:
1. "Show once" means:
   - Once per establishment (any owner)?
   - Once per owner + establishment?
2. If AI fails, should we:
   - Return empty list (current)?
   - Return error response?
   - Use cached data?
3. Do we need custom error responses (400/422/500)?
```

#### 5. Ù…Ù† **DBA/Lead:**
```
Subject: Database Schema for AI Suggestions Tracking

Questions:
1. Store in JSON (current approach) or add columns?
2. Performance concerns?
3. Need index on registrationNo?
```

---

### ğŸŸ¢ **Priority 3 - Nice to Have:**

#### 6. Ù…Ù† **DevOps:**
```
Questions:
1. KVM setup in dev/test/prod?
2. API key rotation policy?
3. Monitoring/alerting setup?
```

---

## ğŸ“Š Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©

| Component | Status | Notes |
|-----------|--------|-------|
| **API Interface** | âœ… Done | Matches spec 100% |
| **API Implementation** | âš ï¸ 90% | Missing: JWT extraction |
| **DTOs** | âœ… Done | Matches spec structure |
| **Service Logic** | âš ï¸ 80% | Need to confirm business rule |
| **AI Proxy** | âš ï¸ 50% | Placeholders for URL/headers |
| **Database** | âš ï¸ Done | Using JSON (need confirmation) |
| **Error Handling** | âš ï¸ Basic | AI failure returns empty list |
| **Apigee Proxy #1** | âœ… Done | UI â†’ OWS |
| **Apigee Proxy #2** | âŒ Pending | Need AI endpoint |
| **Developer App** | âœ… Done | API Key created |
| **KVM** | â³ Optional | For production |

---

## âœ… Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©

### Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:
1. âœ‰ï¸ Send emails to AI Team, Security Team, Apigee Team
2. ğŸ“ Get answers for all placeholder TODOs
3. ğŸ”§ Update code with real values
4. ğŸ§ª Test with actual AI endpoint

### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø¬Ø§ÙŠ:
5. ğŸ—ï¸ Create Apigee Proxy #2
6. ğŸ” Setup KVM (optional)
7. âœ… End-to-end testing
8. ğŸ“ Update documentation

---

**ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:** 27 Ø£ÙƒØªÙˆØ¨Ø± 2025  
**Ø§Ù„Ø­Ø§Ù„Ø©:** 70% Ù…ÙƒØªÙ…Ù„ - Ù…Ø­ØªØ§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ¹Ù„ÙŠØ© Ù…Ù† Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø£Ø®Ø±Ù‰
