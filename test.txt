┌─────────────────────────────────────────────────────────────────┐
│                         FRONTEND                                │
│  User clicks "Show AI Suggestions" for Establishment 501234567  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    HTTP REQUEST                                 │
│  GET /owner-sphere/b2b/501234567/suggestions                   │
│  Headers:                                                       │
│    - Authorization: Bearer <JWT_TOKEN>                         │
│    - Accept: application/json                                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              ⚙️ LAYER 1: API CONTROLLER                         │
│                                                                 │
│  📄 File: B2BSuggestionsApiImpl.java                           │
│  📍 Location: osp-api/src/main/java/.../api/b2b/              │
│                                                                 │
│  ✅ What happens here:                                         │
│    1️⃣ Log incoming request                                     │
│    2️⃣ Extract regNo from path (501234567)                     │
│    3️⃣ Get personId from JWT token (security context)          │
│    4️⃣ Call service layer                                       │
│    5️⃣ Handle null response defensively                         │
│    6️⃣ Return ResponseEntity.ok(response)                       │
│                                                                 │
│  📝 Code:                                                       │
│    SuggestionsResponse response =                              │
│        suggestionsService.getAiSuggestions(regNo, personId);  │
│    return ResponseEntity.ok(response);                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│         🧠 LAYER 2: BUSINESS LOGIC / SERVICE                    │
│                                                                 │
│  📄 File: EstablishmentSuggestionsService.java                 │
│  📍 Location: ownersphere/src/main/java/.../service/          │
│                                                                 │
│  ✅ What happens here:                                         │
│    1️⃣ Query database for OwnerSphereProfile                   │
│       ↳ SELECT * FROM T_OWNERSPHEREPROFILE                    │
│         WHERE ESTABLISHMENTID = regNo                          │
│                                                                 │
│    2️⃣ Check if profile exists                                  │
│       ├─ ❌ NOT FOUND:                                         │
│       │   ↳ Call AI directly (no tracking)                    │
│       │   ↳ Return AI response                                │
│       │                                                        │
│       └─ ✅ FOUND:                                             │
│           ↳ Read profileData JSON column                      │
│           ↳ Check aiSuggestionsShown flag                     │
│                                                                 │
│    3️⃣ Check if already shown                                   │
│       ├─ ✅ YES (aiSuggestionsShown = true):                  │
│       │   ↳ Log "already shown"                               │
│       │   ↳ Return empty list []                              │
│       │   ↳ STOP (no AI call)                                 │
│       │                                                        │
│       └─ ❌ NO (aiSuggestionsShown = null/false):             │
│           ↳ Call AI proxy                                     │
│           ↳ Update flag: aiSuggestionsShown = true           │
│           ↳ Save date: aiSuggestionsFirstShownDate = today   │
│           ↳ Save to database                                  │
│           ↳ Return AI response                                │
│                                                                 │
│  📝 Code Flow:                                                  │
│    if (profileData.getAiSuggestionsShown() == true) {         │
│        return emptyResponse();  // Cached behavior            │
│    }                                                           │
│    SuggestionsResponse ai = osbAiProxy.fetch(regNo);          │
│    profileData.setAiSuggestionsShown(true);                   │
│    repository.save(profile);                                   │
│    return ai;                                                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│           🔌 LAYER 3: INTEGRATION / PROXY                       │
│                                                                 │
│  📄 File: OsbAiProxy.java                                      │
│  📍 Location: ownersphere/src/main/java/.../proxy/service/    │
│                                                                 │
│  ✅ What happens here:                                         │
│    1️⃣ Generate UUID for request tracking                       │
│       ↳ requestId = UUID.randomUUID()                         │
│       ↳ Example: "cad7f12a-4096-47a9-a8f8-631d98685032"       │
│                                                                 │
│    2️⃣ Prepare HTTP request                                     │
│       ↳ URL: apigeeBaseUrl + "/v1/gosi-brain/service-..."    │
│       ↳ Method: POST                                          │
│       ↳ Headers:                                               │
│         • Content-Type: application/json                      │
│         • X-Request-Id: {uuid}                                │
│       ↳ Body:                                                  │
│         {                                                      │
│           "registrationNumber": 501234567,                    │
│           "requestId": "uuid-here"                            │
│         }                                                      │
│                                                                 │
│    3️⃣ Call Apigee AI service                                   │
│       ↳ restTemplate.exchange(url, POST, entity, ...)        │
│                                                                 │
│    4️⃣ Handle response/errors                                   │
│       ├─ ✅ Success (200 OK):                                  │
│       │   ↳ Deserialize JSON → SuggestionsResponse           │
│       │   ↳ Log success + count                               │
│       │   ↳ Return response                                   │
│       │                                                        │
│       ├─ ❌ Client Error (4xx):                                │
│       │   ↳ throw OsbAiServiceException                       │
│       │   ↳ includes requestId for tracking                   │
│       │                                                        │
│       ├─ ❌ Server Error (5xx):                                │
│       │   ↳ throw OsbAiServiceException                       │
│       │                                                        │
│       ├─ ❌ Timeout/Network Error:                             │
│       │   ↳ throw OsbAiServiceException                       │
│       │                                                        │
│       └─ ❌ Unexpected Error:                                  │
│           ↳ throw OsbAiServiceException                       │
│                                                                 │
│  📝 Error Handling Code:                                        │
│    try {                                                       │
│        ResponseEntity<SuggestionsResponse> response =         │
│            restTemplate.exchange(...);                         │
│        return response.getBody();                              │
│    } catch (HttpClientErrorException e) {                     │
│        throw new OsbAiServiceException("Client error", e, id);│
│    } catch (HttpServerErrorException e) {                     │
│        throw new OsbAiServiceException("Server error", e, id);│
│    } catch (ResourceAccessException e) {                      │
│        throw new OsbAiServiceException("Timeout", e, id);     │
│    } catch (Exception e) {                                    │
│        throw new OsbAiServiceException("Unexpected", e, id);  │
│    }                                                           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│               🌐 EXTERNAL: APIGEE GATEWAY                       │
│                                                                 │
│  📍 Endpoint: POST /v1/gosi-brain/service-recommendation       │
│  🔐 Security: API Key (handled by OSB layer)                   │
│  📊 Policies:                                                   │
│    ✅ API Key validation                                       │
│    ✅ Rate limiting                                            │
│    ✅ Request/Response transformation                          │
│    ✅ Logging & monitoring                                     │
│                                                                 │
│  ⚙️ Processing:                                                 │
│    1️⃣ Validate API key                                         │
│    2️⃣ Transform request if needed                              │
│    3️⃣ Route to AI service backend                              │
│    4️⃣ Transform response                                       │
│    5️⃣ Add tracking headers                                     │
│    6️⃣ Return to caller                                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              🤖 GOSI AI SERVICE (GOSI Brain)                    │
│                                                                 │
│  🧠 AI Model processes:                                         │
│    • Registration number analysis                              │
│    • Business relationship patterns                            │
│    • Industry sector matching                                  │
│    • Geographic proximity                                      │
│    • Supply chain connections                                  │
│                                                                 │
│  📤 Returns:                                                     │
│    {                                                            │
│      "establishments": [                                        │
│        {                                                        │
│          "establishmentName": "شركة النور للتجارة",            │
│          "registrationNumber": 501111111,                      │
│          "establishmentLocation": "Riyadh",                    │
│          "unn": 7000000001,                                    │
│          "aiConfidenceScore": 0.95,                            │
│          "matchReason": "Similar business activity"            │
│        },                                                       │
│        ...                                                      │
│      ]                                                          │
│    }                                                            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   ⬅️ RESPONSE FLOWS BACK                        │
│                                                                 │
│  AI Service → Apigee → OsbAiProxy → Service → Controller      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              💾 DATABASE UPDATE (if first time)                 │
│                                                                 │
│  UPDATE T_OWNERSPHEREPROFILE                                   │
│  SET PROFILEDATA = '{                                           │
│    "aiSuggestionsShown": true,                                 │
│    "aiSuggestionsFirstShownDate": "2025-10-29",               │
│    ...other fields                                             │
│  }'                                                             │
│  WHERE PROFILEID = ...                                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                  📡 HTTP RESPONSE TO FRONTEND                   │
│                                                                 │
│  Status: 200 OK                                                │
│  Content-Type: application/json                                │
│                                                                 │
│  Body:                                                          │
│  {                                                              │
│    "establishments": [                                          │
│      {                                                          │
│        "establishmentName": "شركة النور للتجارة",              │
│        "registrationNumber": 501111111,                        │
│        "establishmentLocation": "Riyadh",                      │
│        "unn": 7000000001                                       │
│      },                                                         │
│      {                                                          │
│        "establishmentName": "مؤسسة الأمل",                      │
│        "registrationNumber": 501222222,                        │
│        "establishmentLocation": "Jeddah",                      │
│        "unn": 7000000002                                       │
│      }                                                          │
│    ]                                                            │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        FRONTEND DISPLAY                         │
│  User sees list of suggested establishments                     │
└─────────────────────────────────────────────────────────────────┘
