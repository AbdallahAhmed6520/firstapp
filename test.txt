# ğŸ“– **Ø´Ø±Ø­ Implementation Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„ØªÙØµÙŠÙ„**

---

## **ğŸ¯ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:**

Ø¥Ù†Ø´Ø§Ø¡ API Ø¬Ø¯ÙŠØ¯ ÙŠØ¹Ø±Ø¶ **Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø¢Øª** (AI-Powered Suggestions) Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ ØµÙØ­Ø© B2BØŒ Ù…Ø¹ **Ù‚Ø§Ø¹Ø¯Ø© Ø¹Ù…Ù„ Ù…Ù‡Ù…Ø©**: Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ØªØ¸Ù‡Ø± **Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·** Ù„ÙƒÙ„ Ù…Ù†Ø´Ø£Ø©.

---

## **ğŸ—ï¸ Architecture Flow:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   UI/Web    â”‚ â”€â”€â”€â–º â”‚   Apigee    â”‚ â”€â”€â”€â–º â”‚ OWS Backend â”‚ â”€â”€â”€â–º â”‚ Apigee  â”‚ â”€â”€â”€â–º â”‚   OSB   â”‚ â”€â”€â”€â–º AI Service
â”‚             â”‚      â”‚   Proxy #1  â”‚      â”‚ (Controller)â”‚      â”‚ Proxy#2 â”‚      â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                     â”‚                    â”‚
                           â”‚                     â”‚                    â”‚
                      Security/Auth         Business Logic      NEW (to create)
                                                  â”‚
                                                  â–¼
                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                           â”‚  Database   â”‚
                                           â”‚  (Tracking) â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## **ğŸ“ Files Structure:**

### **1ï¸âƒ£ DTOs (Data Transfer Objects):**
Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù„ÙØ§Øª: `ownersphere/src/main/java/sa/gov/gosi/si/osp/business/ownersphere/dto/`

#### **Ø£) SuggestionsResponse.java**
```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@JsonInclude(JsonInclude.Include.NON_NULL)
public class SuggestionsResponse implements Serializable {
    private List<EstablishmentSuggestion> establishments;
}
```

**Ø§Ù„ØºØ±Ø¶:** Response Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù€ API  
**Ø§Ù„Ù…Ø­ØªÙˆÙ‰:** ÙÙ‚Ø· array Ù…Ù† establishments  
**Ù„Ù…Ø§Ø°Ø§ Ø¨Ø³ÙŠØ·ØŸ** Ù„Ø£Ù† Ø§Ù„Ù€ API Spec ÙŠØ­Ø¯Ø¯ Response Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´ÙƒÙ„ ÙÙ‚Ø·:
```json
{
  "establishments": [...]
}
```

---

#### **Ø¨) EstablishmentSuggestion.java**
```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class EstablishmentSuggestion implements Serializable {
    private String establishmentName;           // Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©
    private String establishmentLocation;       // Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†Ø´Ø£Ø©
    private DateInfo startDate;                 // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    private Long unn;                           // Ø±Ù‚Ù… Ù…ÙˆØ­Ø¯ ÙˆØ·Ù†ÙŠ
    private Long registrationNumber;            // Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„
    private BilingualText suggestionReason;     // Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ (Ø¹Ø±Ø¨ÙŠ/Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ)
}
```

**Ø§Ù„ØºØ±Ø¶:** ØªÙ…Ø«ÙŠÙ„ Ù…Ù†Ø´Ø£Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ù‚ØªØ±Ø­Ø©  
**Fields:** ÙƒÙ„Ù‡Ø§ Ù…Ù† Ø§Ù„Ù€ API Spec - ÙƒÙ„ field Ù„Ù‡ Ù…Ø¹Ù†Ù‰:
- `establishmentName`: Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©
- `establishmentLocation`: Ù…ÙˆÙ‚Ø¹Ù‡Ø§ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
- `startDate`: ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø´Ø§Ø·
- `unn`: Unified National Number
- `registrationNumber`: Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„
- `suggestionReason`: **Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹** - Ø§Ù„Ø³Ø¨Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙˆØ§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ (Ù…Ø«Ø§Ù„: "Ù†ÙØ³ Ø§Ù„Ù…Ø§Ù„Ùƒ"ØŒ "Same Owner")

---

#### **Ø¬) DateInfo.java**
```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class DateInfo implements Serializable {
    private String entryFormat;    // "GREGORIAN" Ø£Ùˆ "HIJRI"
    private String gregorian;      // "2025-10-26T12:30:00.000Z"
    private String hijiri;         // "1447-04-23"
}
```

**Ø§Ù„ØºØ±Ø¶:** Ø¯Ø¹Ù… Ø§Ù„ØªÙ‚ÙˆÙŠÙ…ÙŠÙ† (Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ ÙˆØ§Ù„Ù‡Ø¬Ø±ÙŠ)  
**Ù„Ù…Ø§Ø°Ø§ØŸ** Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ ÙŠØ­ØªØ§Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠÙ† Ø¯Ø§Ø¦Ù…Ø§Ù‹  
**Format:**
- Gregorian: ISO 8601 format
- Hijiri: Simple date format

---

#### **Ø¯) SuggestionsActionRequest.java**
```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class SuggestionsActionRequest implements Serializable {
    @NotNull(message = "Action is required")
    private String action;              // "FOLLOWED", "SKIPPED", "VIEWED"
    
    @Min(value = 0)
    private Integer followedCount;      // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø´Ø¢Øª Ø§Ù„Ù„ÙŠ ØªØ§Ø¨Ø¹Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
}
```

**Ø§Ù„ØºØ±Ø¶:** ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª  
**Ø§Ù„Ù€ Actions Ø§Ù„Ù…Ù…ÙƒÙ†Ø©:**
- `FOLLOWED`: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ§Ø¨Ø¹ Ø¨Ø¹Ø¶/ÙƒÙ„ Ø§Ù„Ù…Ù†Ø´Ø¢Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©
- `SKIPPED`: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ®Ø·Ù‰ ÙƒÙ„ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
- `VIEWED`: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø´Ø§Ù Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¨Ø³ Ù…Ø§ Ø¹Ù…Ù„ Ø´ÙŠ

---

### **2ï¸âƒ£ Controller Layer:**
Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù: B2BSuggestionsController.java

```java
@GosiRestController
@Slf4j
@RequestMapping(value = "/owner-sphere/b2b", produces = MediaType.APPLICATION_JSON_VALUE)
public class B2BSuggestionsController {

    @Autowired
    private EstablishmentSuggestionsService suggestionsService;
```

**Ø§Ù„ØºØ±Ø¶:** Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù€ API  
**Annotations:**
- `@GosiRestController`: Custom annotation Ù„Ù„Ù€ REST controllers ÙÙŠ GOSI
- `@Slf4j`: Ù„Ù„Ù€ logging
- `@RequestMapping`: Base path Ù„ÙƒÙ„ Ø§Ù„Ù€ endpoints

---

#### **Endpoint #1: GET Suggestions**
```java
@GetMapping("/{regNo}/suggestions")
@AmeenReadOnlyTransaction
public ResponseEntity<SuggestionsResponse> getSuggestions(
    @PathVariable("regNo") @NotNull Long regNo
) {
    log.info("Received suggestions request for regNo: {}", regNo);
    
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ personId Ù…Ù† JWT token
    Long personId = getCurrentPersonId();
    
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø©
    SuggestionsResponse response = suggestionsService.getAiSuggestions(regNo, personId);
    
    log.info("Returning {} establishments for regNo: {}", 
        response.getEstablishments() != null ? response.getEstablishments().size() : 0, 
        regNo);
    
    return ResponseEntity.ok(response);
}
```

**Ø§Ù„Ø´Ø±Ø­ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ:**
1. **Path:** `/owner-sphere/b2b/{regNo}/suggestions`
2. **Method:** GET (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)
3. **Input:** Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ (regNo) Ù…Ù† Ø§Ù„Ù€ URL
4. **Process:**
   - ÙŠØ³ØªØ®Ø±Ø¬ `personId` Ù…Ù† JWT token (Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ)
   - ÙŠØ³ØªØ¯Ø¹ÙŠ Service Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
   - ÙŠØ±Ø¬Ø¹ Response
5. **@AmeenReadOnlyTransaction:** ÙŠÙØªØ­ read-only transaction (Ù…Ø§ ÙŠØ¹Ø¯Ù„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)

**âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:** Ø§Ù„Ù€ API Spec **Ù…Ø§ ÙÙŠÙ‡** `personId` ÙƒÙ€ query parameterØŒ Ù„Ø°Ù„Ùƒ Ù†Ø³ØªØ®Ø±Ø¬Ù‡ Ù…Ù† Ø§Ù„Ù€ JWT token Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø·Ù„Ø¨Ù‡ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….

---

#### **Endpoint #2: POST Action**
```java
@PostMapping("/{regNo}/suggestions/action")
@AmeenTransaction
public ResponseEntity<Void> recordAction(
    @PathVariable("regNo") @NotNull Long regNo,
    @Valid @RequestBody SuggestionsActionRequest actionRequest
) {
    log.info("Recording action for regNo: {}, action: {}", regNo, actionRequest.getAction());
    
    suggestionsService.recordUserAction(
        regNo, 
        actionRequest.getAction(), 
        actionRequest.getFollowedCount()
    );
    
    return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
}
```

**Ø§Ù„Ø´Ø±Ø­ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ:**
1. **Path:** `/owner-sphere/b2b/{regNo}/suggestions/action`
2. **Method:** POST (ÙƒØªØ§Ø¨Ø©/ØªØ¹Ø¯ÙŠÙ„)
3. **Input:** 
   - `regNo` Ù…Ù† URL
   - `SuggestionsActionRequest` Ù…Ù† Request Body
4. **Process:**
   - ÙŠØ³ØªÙ‚Ø¨Ù„ Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (follow/skip/view)
   - ÙŠØ³Ø¬Ù„Ù‡ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
   - ÙŠØ±Ø¬Ø¹ 204 No Content (Ù†Ø¬Ø­ Ø¨Ø¯ÙˆÙ† Ù…Ø­ØªÙˆÙ‰)
5. **@AmeenTransaction:** ÙŠÙØªØ­ read-write transaction (ÙŠØ¹Ø¯Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
6. **@Valid:** ÙŠØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø«Ù„Ø§Ù‹ action Ù…Ùˆ null)

---

#### **Endpoint #3: Should Display (Utility)**
```java
@GetMapping("/{regNo}/suggestions/should-display")
@AmeenReadOnlyTransaction
public ResponseEntity<Boolean> shouldDisplaySuggestions(
    @PathVariable("regNo") @NotNull Long regNo
) {
    boolean shouldDisplay = suggestionsService.shouldDisplaySuggestions(regNo);
    log.info("Should display suggestions for regNo {}: {}", regNo, shouldDisplay);
    return ResponseEntity.ok(shouldDisplay);
}
```

**Ø§Ù„ØºØ±Ø¶:** Utility endpoint Ù„Ù„Ù€ UI  
**Ø§Ù„ÙØ§Ø¦Ø¯Ø©:** Ø§Ù„Ù€ UI ÙŠÙ‚Ø¯Ø± ÙŠØªØ­Ù‚Ù‚ Ù‚Ø¨Ù„ Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø©: Ù‡Ù„ ÙŠØ¹Ø±Ø¶ panel Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ÙˆÙ„Ø§ Ù„Ø§ØŸ  
**Returns:**
- `true`: Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª (Ø£ÙˆÙ„ Ù…Ø±Ø©)
- `false`: Ù„Ø§ ØªØ¹Ø±Ø¶ (ØªÙ… Ø§Ù„Ø¹Ø±Ø¶ Ø³Ø§Ø¨Ù‚Ø§Ù‹)

---

### **3ï¸âƒ£ Service Layer (Business Logic):**
Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù: EstablishmentSuggestionsService.java

```java
@Slf4j
@Service
public class EstablishmentSuggestionsService {

    @Autowired
    private OsbAiProxy osbAiProxy;  // Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ AI
    
    @Autowired
    private EstablishmentSuggestionsStatusRepository statusRepository;  // Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
```

**Ø§Ù„ØºØ±Ø¶:** ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ **Business Logic Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©**  
**Dependencies:**
- `OsbAiProxy`: Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ AI service
- `EstablishmentSuggestionsStatusRepository`: Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

---

#### **Method #1: getAiSuggestions()**
```java
@Transactional(readOnly = true)
public SuggestionsResponse getAiSuggestions(Long regNo, Long personId) {
    log.info("Fetching AI suggestions for regNo: {}, personId: {}", regNo, personId);

    // 1ï¸âƒ£ ØªØ­Ù‚Ù‚: Ù‡Ù„ ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŸ
    boolean alreadyShown = statusRepository.wereSuggestionsShown(regNo);

    if (alreadyShown) {
        // âœ‹ ØªÙ… Ø§Ù„Ø¹Ø±Ø¶ Ø³Ø§Ø¨Ù‚Ø§Ù‹ - Ø£Ø±Ø¬Ø¹ response ÙØ§Ø¶ÙŠ
        log.info("Suggestions already shown for regNo: {}. Returning empty response.", regNo);
        return new SuggestionsResponse(null);  // establishments = null
    }

    // 2ï¸âƒ£ Ø£ÙˆÙ„ Ù…Ø±Ø© - Ø§Ø³ØªØ¯Ø¹ÙŠ AI service
    SuggestionsResponse response = osbAiProxy.fetchAiSuggestions(regNo);

    // 3ï¸âƒ£ Ø³Ø¬Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: "ØªÙ… Ø§Ù„Ø¹Ø±Ø¶"
    recordSuggestionsShown(regNo, personId);

    return response;  // Ø£Ø±Ø¬Ø¹ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
}
```

**Ø§Ù„Ø´Ø±Ø­ Ø¨Ø§Ù„Ø®Ø·ÙˆØ§Øª:**

**Ø®Ø·ÙˆØ© 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª**
```java
boolean alreadyShown = statusRepository.wereSuggestionsShown(regNo);
```
- ÙŠØ¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„: Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ `regNo`ØŸ
- Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ â†’ `alreadyShown = true`
- Ø¥Ø°Ø§ Ù…Ùˆ Ù…ÙˆØ¬ÙˆØ¯ â†’ `alreadyShown = false`

**Ø®Ø·ÙˆØ© 2: Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¹Ø±Ø¶ Ø³Ø§Ø¨Ù‚Ø§Ù‹**
```java
if (alreadyShown) {
    return new SuggestionsResponse(null);
}
```
- ÙŠØ±Ø¬Ø¹ response ÙØ§Ø¶ÙŠ: `{ "establishments": null }`
- Ø§Ù„Ù€ UI ÙŠÙÙ‡Ù…: Ù„Ø§ ØªØ¹Ø±Ø¶ panel Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª

**Ø®Ø·ÙˆØ© 3: Ø£ÙˆÙ„ Ù…Ø±Ø© - Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ AI**
```java
SuggestionsResponse response = osbAiProxy.fetchAiSuggestions(regNo);
```
- ÙŠØ³ØªØ¯Ø¹ÙŠ Proxy Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ AI
- AI ÙŠØ±Ø¬Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø´Ø¢Øª Ù…Ù‚ØªØ±Ø­Ø©

**Ø®Ø·ÙˆØ© 4: Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª**
```java
recordSuggestionsShown(regNo, personId);
```
- ÙŠÙ†Ø´Ø¦ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
- ÙŠØ­ÙØ¸: regNo + personId + timestamp + flag "shown = true"

**Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:**
- **Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰:** AI suggestions ØªØ±Ø¬Ø¹ â†’ ØªÙ†Ø­ÙØ¸ ÙÙŠ DB â†’ User ÙŠØ´ÙˆÙÙ‡Ø§
- **Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù„Ø§Ø­Ù‚Ø©:** DB ØªÙ‚ÙˆÙ„ "ØªÙ… Ø§Ù„Ø¹Ø±Ø¶" â†’ Null ØªØ±Ø¬Ø¹ â†’ User Ù…Ø§ ÙŠØ´ÙˆÙ Ø´ÙŠ

---

#### **Method #2: recordUserAction()**
```java
@Transactional
public void recordUserAction(Long regNo, String action, Integer followedCount) {
    log.info("Recording action for regNo: {}, action: {}, count: {}", regNo, action, followedCount);

    // 1ï¸âƒ£ Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
    EstablishmentSuggestionsStatusEntity status = statusRepository.findByRegistrationNo(regNo)
        .orElseThrow(() -> new IllegalStateException("Suggestions status not found for regNo: " + regNo));

    // 2ï¸âƒ£ Ø­Ø¯Ù‘Ø« Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    status.setUserAction(action);                           // "FOLLOWED" / "SKIPPED" / "VIEWED"
    status.setFollowedCount(followedCount != null ? followedCount : 0);
    status.setActionDate(LocalDateTime.now());              // ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡

    // 3ï¸âƒ£ Ø§Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
    statusRepository.save(status);
    log.info("Action recorded successfully for regNo: {}", regNo);
}
```

**Ø§Ù„Ø´Ø±Ø­:**
1. **ÙŠØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„:** Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ (Ù„Ø£Ù† `recordSuggestionsShown()` Ø£Ù†Ø´Ø£Ù‡)
2. **ÙŠØ­Ø¯Ù‘Ø« Ø§Ù„Ù€ fields:**
   - `userAction`: "FOLLOWED", "SKIPPED", Ø£Ùˆ "VIEWED"
   - `followedCount`: Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø´Ø¢Øª Ø§Ù„Ù„ÙŠ ØªØ§Ø¨Ø¹Ù‡Ø§ (0 Ø¥Ø°Ø§ skipped)
   - `actionDate`: Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
3. **ÙŠØ­ÙØ¸:** UPDATE ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

**Ù…Ø«Ø§Ù„:**
```
Before: { regNo: 12345, shown: true, action: null, count: null }
After:  { regNo: 12345, shown: true, action: "FOLLOWED", count: 3 }
```

---

#### **Method #3: shouldDisplaySuggestions()**
```java
@Transactional(readOnly = true)
public boolean shouldDisplaySuggestions(Long regNo) {
    return !statusRepository.wereSuggestionsShown(regNo);
}
```

**Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹:**
- `true` â†’ Ù…Ø§ ØªÙ… Ø§Ù„Ø¹Ø±Ø¶ â†’ Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
- `false` â†’ ØªÙ… Ø§Ù„Ø¹Ø±Ø¶ â†’ Ù„Ø§ ØªØ¹Ø±Ø¶

---

#### **Private Method: recordSuggestionsShown()**
```java
private void recordSuggestionsShown(Long regNo, Long personId) {
    EstablishmentSuggestionsStatusEntity status = new EstablishmentSuggestionsStatusEntity();
    status.setRegistrationNo(regNo);
    status.setSuggestionsShown(true);           // ğŸ”‘ Ø§Ù„Ù…ÙØªØ§Ø­: "ØªÙ… Ø§Ù„Ø¹Ø±Ø¶"
    status.setFirstShownDate(LocalDateTime.now());
    status.setPersonId(personId);
    status.setFollowedCount(0);

    statusRepository.save(status);
    log.info("Recorded suggestions shown for regNo: {}, personId: {}", regNo, personId);
}
```

**Ø§Ù„ØºØ±Ø¶:** Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ = "ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©"  
**Ø§Ù„Ù…Ø­ØªÙˆÙ‰:**
- `registrationNo`: Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©
- `suggestionsShown`: **true** (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ù‡Ù…!)
- `firstShownDate`: Ù…ØªÙ‰ ØªÙ… Ø§Ù„Ø¹Ø±Ø¶
- `personId`: Ù…ÙŠÙ† Ø´Ø§Ù Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª

---

### **4ï¸âƒ£ Proxy Layer (HTTP Client):**
Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù: OsbAiProxy.java

```java
@Slf4j
@Service
public class OsbAiProxy {

    @Value("${api.base.url}")
    private String apigeeBaseUrl;  // http://amnapigeedev.gosi.ins:9640

    @Value("${app.apikey}")
    private String apiKey;         // API Key Ù„Ù„Ù€ Apigee

    private final RestTemplate restTemplate;
```

**Ø§Ù„ØºØ±Ø¶:** Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ AI Service Ø¹Ø¨Ø± Apigee â†’ OSB  
**Configuration:**
- `apigeeBaseUrl`: Ø¹Ù†ÙˆØ§Ù† Apigee gateway
- `apiKey`: Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù…Ø§Ù†

---

#### **fetchAiSuggestions() Method:**
```java
public SuggestionsResponse fetchAiSuggestions(Long regNo) {
    String requestId = UUID.randomUUID().toString();
    log.info("[RequestId: {}] Fetching AI suggestions for regNo: {}", requestId, regNo);

    try {
        // 1ï¸âƒ£ Ø¨Ù†Ø§Ø¡ URL
        String url = String.format("%s/v1/osb/ai/suggestions?regNo=%d", apigeeBaseUrl, regNo);
        // Ù…Ø«Ø§Ù„: http://amnapigeedev.gosi.ins:9640/v1/osb/ai/suggestions?regNo=12345678
        
        // 2ï¸âƒ£ ØªØ­Ø¶ÙŠØ± Headers
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.set("X-Request-Id", requestId);     // Ù„Ù„Ù€ tracking
        headers.set("apikey", apiKey);              // Ù„Ù„Ù€ authentication
        
        HttpEntity<String> entity = new HttpEntity<>(headers);

        // 3ï¸âƒ£ HTTP Call
        ResponseEntity<SuggestionsResponse> response = restTemplate.exchange(
            url,
            HttpMethod.GET,
            entity,
            SuggestionsResponse.class
        );

        SuggestionsResponse body = response.getBody();
        
        if (body != null) {
            log.info("[RequestId: {}] Successfully received {} establishments from AI", 
                requestId, 
                body.getEstablishments() != null ? body.getEstablishments().size() : 0
            );
        }

        return body;

    } catch (HttpClientErrorException e) {
        // 4xx errors (Ù…Ø«Ù„Ø§Ù‹ 400 Bad Request)
        log.error("[RequestId: {}] Client error calling AI service: {}", requestId, e.getStatusCode());
        return new SuggestionsResponse(Collections.emptyList());

    } catch (HttpServerErrorException e) {
        // 5xx errors (Ù…Ø«Ù„Ø§Ù‹ 500 Internal Server Error)
        log.error("[RequestId: {}] Server error from AI service: {}", requestId, e.getStatusCode());
        return new SuggestionsResponse(Collections.emptyList());

    } catch (ResourceAccessException e) {
        // Timeout / Connection refused
        log.error("[RequestId: {}] AI service timeout or unreachable: {}", requestId, e.getMessage());
        return new SuggestionsResponse(Collections.emptyList());

    } catch (Exception e) {
        // Any other error
        log.error("[RequestId: {}] Unexpected error calling AI for regNo {}: {}", 
            requestId, regNo, e.getMessage(), e);
        return new SuggestionsResponse(Collections.emptyList());
    }
}
```

**Ø§Ù„Ø´Ø±Ø­ Ø¨Ø§Ù„ØªÙØµÙŠÙ„:**

**1. Ø¨Ù†Ø§Ø¡ URL:**
```java
String url = String.format("%s/v1/osb/ai/suggestions?regNo=%d", apigeeBaseUrl, regNo);
```
- Base: `http://amnapigeedev.gosi.ins:9640`
- Path: `/v1/osb/ai/suggestions`
- Query: `?regNo=12345678`
- **Result:** `http://amnapigeedev.gosi.ins:9640/v1/osb/ai/suggestions?regNo=12345678`

**2. Headers:**
```java
headers.set("X-Request-Id", requestId);  // UUID Ù„Ù„Ù€ tracking/debugging
headers.set("apikey", apiKey);           // Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù…Ø§Ù†
```

**3. HTTP Call:**
```java
restTemplate.exchange(url, HttpMethod.GET, entity, SuggestionsResponse.class)
```
- ÙŠØ±Ø³Ù„ GET request
- ÙŠÙ†ØªØ¸Ø± Response
- ÙŠØ­ÙˆÙ‘Ù„ JSON â†’ `SuggestionsResponse` object

**4. Error Handling (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹!):**

**Ø£) 4xx Errors (Client Errors):**
```java
catch (HttpClientErrorException e) {
    // Ù…Ø«Ù„Ø§Ù‹: 400 Bad Request, 404 Not Found
    return new SuggestionsResponse(Collections.emptyList());
}
```
- Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…Ù† Ø·Ø±ÙÙ†Ø§ (wrong parameters, etc.)
- ÙŠØ±Ø¬Ø¹ list ÙØ§Ø¶ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† crash

**Ø¨) 5xx Errors (Server Errors):**
```java
catch (HttpServerErrorException e) {
    // Ù…Ø«Ù„Ø§Ù‹: 500 Internal Server Error
    return new SuggestionsResponse(Collections.emptyList());
}
```
- Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…Ù† AI service
- ÙŠØ±Ø¬Ø¹ list ÙØ§Ø¶ÙŠ

**Ø¬) Timeout/Connection:**
```java
catch (ResourceAccessException e) {
    // AI service down Ø£Ùˆ Ø¨Ø·ÙŠØ¡
    return new SuggestionsResponse(Collections.emptyList());
}
```

**Ø§Ù„ÙÙ„Ø³ÙØ©:** **Graceful Degradation**
- Ø¥Ø°Ø§ AI service ÙØ´Ù„ â†’ Ù„Ø§ ØªÙƒØ³Ø± Ø§Ù„Ù€ API
- Ø£Ø±Ø¬Ø¹ list ÙØ§Ø¶ÙŠ â†’ User experience Ø£ÙØ¶Ù„

---

### **5ï¸âƒ£ Database Layer:**

#### **Ø£) Entity (Ø§Ù„Ø¬Ø¯ÙˆÙ„):**
Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù: EstablishmentSuggestionsStatusEntity.java

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder(toBuilder = true)
@EqualsAndHashCode(callSuper = false)
@Entity
@Table(name = "OSP_ESTABLISHMENT_SUGGESTIONS_STATUS", schema = "OWS_ADMIN")
public class EstablishmentSuggestionsStatusEntity extends Auditable {

    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "OSP_EST_SUGGESTIONS_SEQ")
    @SequenceGenerator(name = "OSP_EST_SUGGESTIONS_SEQ", sequenceName = "OSP_EST_SUGGESTIONS_SEQ", allocationSize = 1)
    @Column(name = "ID")
    private Long id;

    @Column(name = "REGISTRATION_NO", nullable = false, unique = true)
    private Long registrationNo;  // ğŸ”‘ Unique constraint

    @Column(name = "SUGGESTIONS_SHOWN", nullable = false)
    private Boolean suggestionsShown = false;  // ğŸ¯ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ

    @Column(name = "USER_ACTION", length = 20)
    private String userAction;  // "FOLLOWED", "SKIPPED", "VIEWED"

    @Column(name = "FOLLOWED_COUNT")
    private Integer followedCount = 0;

    @Column(name = "FIRST_SHOWN_DATE")
    private LocalDateTime firstShownDate;

    @Column(name = "ACTION_DATE")
    private LocalDateTime actionDate;

    @Column(name = "PERSON_ID")
    private Long personId;
}
```

**Ø§Ù„Ø´Ø±Ø­:**

**JPA Annotations:**
- `@Entity`: Ù‡Ø°Ø§ class ÙŠÙ…Ø«Ù„ Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
- `@Table`: Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ = `OSP_ESTABLISHMENT_SUGGESTIONS_STATUS`
- `@Id`: Primary key
- `@GeneratedValue`: auto-increment Ù…Ù† sequence
- `@Column`: ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ ÙˆØ§Ù„Ø®ØµØ§Ø¦Øµ

**Fields Ø§Ù„Ù…Ù‡Ù…Ø©:**

**1. registrationNo:**
```java
@Column(name = "REGISTRATION_NO", nullable = false, unique = true)
private Long registrationNo;
```
- **Unique constraint:** ÙƒÙ„ Ù…Ù†Ø´Ø£Ø© Ù„Ù‡Ø§ Ø³Ø¬Ù„ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·!
- **Not null:** Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯

**2. suggestionsShown:**
```java
@Column(name = "SUGGESTIONS_SHOWN", nullable = false)
private Boolean suggestionsShown = false;
```
- **Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù†Ø§Ø¨Ø¶ Ù„Ù„Ù€ business logic!**
- `true` â†’ ØªÙ… Ø§Ù„Ø¹Ø±Ø¶ â†’ Ù„Ø§ ØªØ¹Ø±Ø¶ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©
- `false` â†’ Ù…Ø§ ØªÙ… Ø§Ù„Ø¹Ø±Ø¶ â†’ Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª

**3. userAction:**
```java
@Column(name = "USER_ACTION", length = 20)
private String userAction;
```
- "FOLLOWED": ØªØ§Ø¨Ø¹ Ù…Ù†Ø´Ø¢Øª
- "SKIPPED": ØªØ®Ø·Ù‰ Ø§Ù„ÙƒÙ„
- "VIEWED": Ø´Ø§Ù Ø¨Ø³

**4. followedCount:**
```java
@Column(name = "FOLLOWED_COUNT")
private Integer followedCount = 0;
```
- Ø¥Ø°Ø§ action = FOLLOWED â†’ ÙƒÙ… Ù…Ù†Ø´Ø£Ø© ØªØ§Ø¨Ø¹ØŸ
- Ø¥Ø°Ø§ action = SKIPPED â†’ 0

**5. Timestamps:**
```java
private LocalDateTime firstShownDate;  // Ù…ØªÙ‰ ØªÙ… Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
private LocalDateTime actionDate;      // Ù…ØªÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù…Ù„ action
```

**extends Auditable:**
- ÙŠØ±Ø« fields Ø²ÙŠ `createdBy`, `createdDate`, `lastModifiedBy`, `lastModifiedDate`
- Ù„Ù„Ù€ auditing (Ù…ÙŠÙ† Ø¹Ù…Ù„ Ø§ÙŠØ´ ÙˆÙ…ØªÙ‰)

---

#### **Ø¨) Repository (Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª):**
Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù: `ownersphere/src/main/java/sa/gov/gosi/si/osp/business/ownersphere/repository/EstablishmentSuggestionsStatusRepository.java`

```java
public interface EstablishmentSuggestionsStatusRepository 
    extends JpaRepository<EstablishmentSuggestionsStatusEntity, Long> {

    /**
     * Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³Ø¬Ù„ Ø¨ÙˆØ§Ø³Ø·Ø© registration number
     */
    Optional<EstablishmentSuggestionsStatusEntity> findByRegistrationNo(Long registrationNo);

    /**
     * ØªØ­Ù‚Ù‚: Ù‡Ù„ ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§ØªØŸ
     */
    default boolean wereSuggestionsShown(Long registrationNo) {
        return findByRegistrationNo(registrationNo)
            .map(EstablishmentSuggestionsStatusEntity::getSuggestionsShown)
            .orElse(false);  // Ø¥Ø°Ø§ Ù…Ø§ÙÙŠ Ø³Ø¬Ù„ â†’ false (Ù…Ø§ ØªÙ… Ø§Ù„Ø¹Ø±Ø¶)
    }
}
```

**Ø§Ù„Ø´Ø±Ø­:**

**1. JpaRepository:**
```java
extends JpaRepository<EstablishmentSuggestionsStatusEntity, Long>
```
- Spring Data JPA ÙŠØ¹Ø·ÙŠÙƒ methods Ø¬Ø§Ù‡Ø²Ø©:
  - `save()`: INSERT Ø£Ùˆ UPDATE
  - `findById()`: Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù€ ID
  - `delete()`: Ø§Ø­Ø°Ù
  - ... ÙˆØ§Ù„ÙƒØ«ÙŠØ±

**2. findByRegistrationNo():**
```java
Optional<EstablishmentSuggestionsStatusEntity> findByRegistrationNo(Long registrationNo);
```
- Spring Data **ÙŠÙˆÙ„Ù‘Ø¯** Ù‡Ø°Ø§ Ø§Ù„Ù€ SQL ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:
```sql
SELECT * FROM OSP_ESTABLISHMENT_SUGGESTIONS_STATUS 
WHERE REGISTRATION_NO = ?
```
- ÙŠØ±Ø¬Ø¹ `Optional<Entity>`:
  - Ù…ÙˆØ¬ÙˆØ¯ â†’ `Optional.of(entity)`
  - Ù…Ùˆ Ù…ÙˆØ¬ÙˆØ¯ â†’ `Optional.empty()`

**3. wereSuggestionsShown() - Default Method:**
```java
default boolean wereSuggestionsShown(Long registrationNo) {
    return findByRegistrationNo(registrationNo)
        .map(EstablishmentSuggestionsStatusEntity::getSuggestionsShown)
        .orElse(false);
}
```

**Ø§Ù„Ø´Ø±Ø­ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©:**

```java
findByRegistrationNo(registrationNo)  // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„
```
- ÙŠØ±Ø¬Ø¹ `Optional<Entity>`

```java
.map(EstablishmentSuggestionsStatusEntity::getSuggestionsShown)
```
- Ø¥Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯ â†’ Ø®Ø° Ù‚ÙŠÙ…Ø© `suggestionsShown`
- ÙŠØ±Ø¬Ø¹ `Optional<Boolean>`

```java
.orElse(false)
```
- Ø¥Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ **Ù…ÙˆØ¬ÙˆØ¯** â†’ ÙŠØ±Ø¬Ø¹ `true/false` (Ø­Ø³Ø¨ Ø§Ù„Ù€ field)
- Ø¥Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ **Ù…Ùˆ Ù…ÙˆØ¬ÙˆØ¯** â†’ ÙŠØ±Ø¬Ø¹ `false` (default)

**Ù…Ø«Ø§Ù„:**
```
Case 1: Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯ + shown=true  â†’ ÙŠØ±Ø¬Ø¹ true
Case 2: Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯ + shown=false â†’ ÙŠØ±Ø¬Ø¹ false
Case 3: Ø³Ø¬Ù„ Ù…Ùˆ Ù…ÙˆØ¬ÙˆØ¯           â†’ ÙŠØ±Ø¬Ø¹ false
```

---

#### **Ø¬) SQL Script:**
Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù: `owner-sphere-db-scripts/migration_scripts/create_suggestions_status_table.sql`

```sql
-- 1ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Sequence (Ù„Ù„Ù€ auto-increment)
CREATE SEQUENCE OSP_EST_SUGGESTIONS_SEQ
  START WITH 1
  INCREMENT BY 1
  NOCACHE
  NOCYCLE;

-- 2ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
CREATE TABLE OSP_ESTABLISHMENT_SUGGESTIONS_STATUS (
    ID NUMBER(19) NOT NULL,                              -- Primary Key
    REGISTRATION_NO NUMBER(19) NOT NULL,                 -- Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© (Unique)
    SUGGESTIONS_SHOWN NUMBER(1) DEFAULT 0 NOT NULL,      -- 1=shown, 0=not shown
    USER_ACTION VARCHAR2(20),                            -- FOLLOWED/SKIPPED/VIEWED
    FOLLOWED_COUNT NUMBER(10) DEFAULT 0,                 -- Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª
    FIRST_SHOWN_DATE TIMESTAMP,                          -- Ù…ØªÙ‰ ØªÙ… Ø§Ù„Ø¹Ø±Ø¶
    ACTION_DATE TIMESTAMP,                               -- Ù…ØªÙ‰ ØªÙ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
    PERSON_ID NUMBER(19),                                -- Ù…ÙŠÙ† Ø´Ø§ÙÙ‡Ø§
    CREATED_BY VARCHAR2(255),                            -- Audit
    CREATED_DATE TIMESTAMP DEFAULT SYSTIMESTAMP,         -- Audit
    LAST_MODIFIED_BY VARCHAR2(255),                      -- Audit
    LAST_MODIFIED_DATE TIMESTAMP DEFAULT SYSTIMESTAMP,   -- Audit
    CONSTRAINT PK_OSP_EST_SUGGESTIONS PRIMARY KEY (ID),  -- Primary Key
    CONSTRAINT UK_OSP_EST_SUGGESTIONS_REG UNIQUE (REGISTRATION_NO)  -- Unique!
);

-- 3ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Indexes (Ù„Ù„Ø³Ø±Ø¹Ø©)
CREATE INDEX IDX_OSP_EST_SUGG_REG_NO ON OSP_ESTABLISHMENT_SUGGESTIONS_STATUS(REGISTRATION_NO);
CREATE INDEX IDX_OSP_EST_SUGG_SHOWN ON OSP_ESTABLISHMENT_SUGGESTIONS_STATUS(SUGGESTIONS_SHOWN);

-- 4ï¸âƒ£ Comments (Ù„Ù„ØªÙˆØ«ÙŠÙ‚)
COMMENT ON TABLE OSP_ESTABLISHMENT_SUGGESTIONS_STATUS IS 'Tracks whether AI suggestions were shown for establishments';

-- 5ï¸âƒ£ Permissions
GRANT SELECT, INSERT, UPDATE ON OSP_ESTABLISHMENT_SUGGESTIONS_STATUS TO OWS_USR;
GRANT SELECT ON OSP_EST_SUGGESTIONS_SEQ TO OWS_USR;
```

**Ø§Ù„Ø´Ø±Ø­:**

**1. Sequence:**
- Oracle Ù…Ø§ Ø¹Ù†Ø¯Ù‡ `AUTO_INCREMENT` Ø²ÙŠ MySQL
- Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù†Ù‡ Ù†Ø³ØªØ®Ø¯Ù… `SEQUENCE`
- ÙƒÙ„ INSERT Ø¬Ø¯ÙŠØ¯ ÙŠØ£Ø®Ø° Ø±Ù‚Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ (1, 2, 3, ...)

**2. UNIQUE Constraint:**
```sql
CONSTRAINT UK_OSP_EST_SUGGESTIONS_REG UNIQUE (REGISTRATION_NO)
```
- **Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹!** ÙŠØ¶Ù…Ù†: Ù…Ù†Ø´Ø£Ø© ÙˆØ§Ø­Ø¯Ø© = Ø³Ø¬Ù„ ÙˆØ§Ø­Ø¯
- Ù„Ùˆ Ø­Ø§ÙˆÙ„Øª INSERT Ù†ÙØ³ `regNo` Ù…Ø±ØªÙŠÙ† â†’ Oracle ÙŠØ±ÙØ¶

**3. Indexes:**
```sql
CREATE INDEX IDX_OSP_EST_SUGG_REG_NO ON ... (REGISTRATION_NO);
```
- ÙŠØ³Ø±Ù‘Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ `registrationNo`
- Ø¨Ø¯ÙˆÙ† index â†’ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø·ÙŠØ¡ (Full Table Scan)
- Ù…Ø¹ index â†’ Ø§Ù„Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ (Index Seek)

**4. Permissions:**
```sql
GRANT SELECT, INSERT, UPDATE ON ... TO OWS_USR;
```
- ÙŠØ¹Ø·ÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„Ù€ application user (OWS_USR)
- ÙŠÙ‚Ø¯Ø± ÙŠÙ‚Ø±Ø£/ÙŠØ¶ÙŠÙ/ÙŠØ¹Ø¯Ù„
- **Ù…Ø§ ÙŠÙ‚Ø¯Ø±** ÙŠØ­Ø°Ù (Ù…Ø§ ÙÙŠÙ‡ DELETE)

---

## **ğŸ”„ Complete Flow Example:**

### **Scenario: User ÙŠØ¯Ø®Ù„ Ø¹Ù„Ù‰ Ù…Ù†Ø´Ø£Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©**

```
1ï¸âƒ£ UI â†’ Apigee Proxy #1
   GET /v1/owner-sphere/b2b/12345678/suggestions
   Headers: { Authorization: Bearer <JWT>, x-apikey: xxx }

2ï¸âƒ£ Apigee Proxy #1 â†’ OWS Backend (Controller)
   âœ… Validates JWT
   âœ… Checks API key
   âœ… Routes to B2BSuggestionsController

3ï¸âƒ£ Controller.getSuggestions(12345678)
   â”œâ”€ Extracts personId from JWT â†’ 999
   â””â”€ Calls service.getAiSuggestions(12345678, 999)

4ï¸âƒ£ Service.getAiSuggestions()
   â”œâ”€ Checks DB: statusRepository.wereSuggestionsShown(12345678)
   â”‚  â””â”€ SELECT * FROM OSP_ESTABLISHMENT_SUGGESTIONS_STATUS WHERE REGISTRATION_NO = 12345678
   â”‚  â””â”€ Result: âŒ No record found â†’ returns false
   â”‚
   â”œâ”€ alreadyShown = false â†’ First time!
   â”‚
   â”œâ”€ Calls osbAiProxy.fetchAiSuggestions(12345678)
   â”‚
   â””â”€ Calls recordSuggestionsShown(12345678, 999)
      â””â”€ INSERT INTO OSP_ESTABLISHMENT_SUGGESTIONS_STATUS 
          (ID, REGISTRATION_NO, SUGGESTIONS_SHOWN, PERSON_ID, FIRST_SHOWN_DATE, ...)
          VALUES (1, 12345678, 1, 999, SYSTIMESTAMP, ...)

5ï¸âƒ£ OsbAiProxy.fetchAiSuggestions()
   â”œâ”€ Builds URL: http://apigee.../v1/osb/ai/suggestions?regNo=12345678
   â”œâ”€ Sends GET request with apikey header
   â””â”€ Apigee Proxy #2 â†’ OSB â†’ AI Service
      â””â”€ AI returns: { "establishments": [
            {
              "establishmentName": "Ø´Ø±ÙƒØ© Ø§Ù„Ù†ÙˆØ± Ù„Ù„ØªØ¬Ø§Ø±Ø©",
              "registrationNumber": 987654321,
              "suggestionReason": {
                "arabic": "Ù†ÙØ³ Ø§Ù„Ù…Ø§Ù„Ùƒ",
                "english": "Same Owner"
              },
              ...
            },
            ...
          ]}

6ï¸âƒ£ Service returns response to Controller
   â””â”€ Response: { "establishments": [...] }

7ï¸âƒ£ Controller returns HTTP 200 OK
   â””â”€ Body: { "establishments": [...] }

8ï¸âƒ£ UI receives suggestions
   â”œâ”€ Shows suggestions panel
   â””â”€ User sees: "Ù†Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ Ù…ØªØ§Ø¨Ø¹Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø´Ø¢Øª: Ø´Ø±ÙƒØ© Ø§Ù„Ù†ÙˆØ± Ù„Ù„ØªØ¬Ø§Ø±Ø©ØŒ ..."
```

---

### **Scenario: User ÙŠØ±Ø¬Ø¹ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø´Ø£Ø© (Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©)**

```
1ï¸âƒ£-3ï¸âƒ£ Same as above...

4ï¸âƒ£ Service.getAiSuggestions()
   â”œâ”€ Checks DB: statusRepository.wereSuggestionsShown(12345678)
   â”‚  â””â”€ SELECT * FROM OSP_ESTABLISHMENT_SUGGESTIONS_STATUS WHERE REGISTRATION_NO = 12345678
   â”‚  â””â”€ Result: âœ… Record found! { id: 1, shown: true }
   â”‚  â””â”€ Returns true
   â”‚
   â”œâ”€ alreadyShown = true â†’ Skip AI call!
   â”‚
   â””â”€ return new SuggestionsResponse(null);
      â””â”€ Response: { "establishments": null }

5ï¸âƒ£ Controller returns HTTP 200 OK
   â””â”€ Body: { "establishments": null }

6ï¸âƒ£ UI receives null
   â”œâ”€ âŒ Doesn't show suggestions panel
   â””â”€ Redirects user to B2B page directly
```

---

### **Scenario: User ÙŠØªØ§Ø¨Ø¹ Ù…Ù†Ø´Ø¢Øª**

```
1ï¸âƒ£ UI â†’ POST /v1/owner-sphere/b2b/12345678/suggestions/action
   Body: { "action": "FOLLOWED", "followedCount": 3 }

2ï¸âƒ£ Controller.recordAction(12345678, request)

3ï¸âƒ£ Service.recordUserAction(12345678, "FOLLOWED", 3)
   â”œâ”€ Finds existing record: findByRegistrationNo(12345678)
   â”‚  â””â”€ SELECT * FROM ... WHERE REGISTRATION_NO = 12345678
   â”‚  â””â”€ Returns: { id: 1, shown: true, action: null, ... }
   â”‚
   â””â”€ Updates record:
      â””â”€ UPDATE OSP_ESTABLISHMENT_SUGGESTIONS_STATUS
          SET USER_ACTION = 'FOLLOWED',
              FOLLOWED_COUNT = 3,
              ACTION_DATE = SYSTIMESTAMP
          WHERE ID = 1

4ï¸âƒ£ Controller returns HTTP 204 No Content
   â””â”€ Success!
```

---

## **ğŸ“Š Database State Timeline:**

```
â° Time: T0 (Ù‚Ø¨Ù„ Ø£ÙŠ Ø´ÙŠ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OSP_ESTABLISHMENT_SUGGESTIONS_STATUS Table     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  (empty - no records)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â° Time: T1 (User visits regNo=12345678 - First Time)
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID   â”‚ REGIS_NO   â”‚ SHOWN   â”‚ ACTION â”‚ COUNT   â”‚ FIRST_SHOWN  â”‚ ACTION_DT  â”‚ PERSON   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1    â”‚ 12345678   â”‚ 1       â”‚ NULL   â”‚ 0       â”‚ 2025-10-26   â”‚ NULL       â”‚ 999      â”‚
â”‚      â”‚            â”‚         â”‚        â”‚         â”‚ 02:30:00     â”‚            â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â° Time: T2 (User follows 3 establishments)
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID   â”‚ REGIS_NO   â”‚ SHOWN   â”‚ ACTION   â”‚ COUNT   â”‚ FIRST_SHOWN  â”‚ ACTION_DT  â”‚ PERSON   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1    â”‚ 12345678   â”‚ 1       â”‚ FOLLOWED â”‚ 3       â”‚ 2025-10-26   â”‚ 2025-10-26 â”‚ 999      â”‚
â”‚      â”‚            â”‚         â”‚          â”‚         â”‚ 02:30:00     â”‚ 02:35:00   â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â° Time: T3 (User visits again - Second Time)
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID   â”‚ REGIS_NO   â”‚ SHOWN   â”‚ ACTION   â”‚ COUNT   â”‚ FIRST_SHOWN  â”‚ ACTION_DT  â”‚ PERSON   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1    â”‚ 12345678   â”‚ 1  â†â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      â”‚            â”‚ TRUE!   â”‚ FOLLOWED â”‚ 3       â”‚ 2025-10-26   â”‚ 2025-10-26 â”‚ 999      â”‚
â”‚      â”‚            â”‚ â†“       â”‚          â”‚         â”‚ 02:30:00     â”‚ 02:35:00   â”‚          â”‚
â”‚      â”‚            â”‚ Skip AI!â”‚          â”‚         â”‚              â”‚            â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## **ğŸ¯ Business Rules Summary:**

### **Rule #1: Show Once**
```
IF (record exists in DB with shown=true)
  THEN return null â†’ UI skips panel
  ELSE call AI â†’ save to DB â†’ return suggestions
```

### **Rule #2: Unique Establishment**
```
CONSTRAINT: One record per registrationNo
â†’ Can't have duplicate entries
â†’ Prevents "showing twice" bug
```

### **Rule #3: Action Tracking**
```
User can:
  - FOLLOW (some/all establishments) â†’ Count > 0
  - SKIP (all) â†’ Count = 0
  - VIEW (just close) â†’ Count = 0
```

---

## **ğŸ› ï¸ Error Handling Philosophy:**

### **Graceful Degradation:**
```java
// âŒ Bad approach:
if (aiServiceFails) {
    throw new RuntimeException("AI failed!");  // Breaks entire API
}

// âœ… Good approach:
if (aiServiceFails) {
    return new SuggestionsResponse(Collections.emptyList());  // Empty list
}
```

**Why?**
- AI service ÙØ´Ù„ â†’ User ÙŠØ´ÙˆÙ ØµÙØ­Ø© ÙØ§Ø¶ÙŠØ© (Ø£Ø­Ø³Ù† Ù…Ù† error page)
- Logging Ù…ÙˆØ¬ÙˆØ¯ â†’ Developers ÙŠØ¹Ø±ÙÙˆÙ† Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
- User experience Ù…Ø§ ÙŠÙ†ÙƒØ³Ø±

---

## **ğŸ“ Key Takeaways:**

1. **DTOs** = Contract Ù…Ø¹ Ø§Ù„Ù€ UI (per API Spec)
2. **Controller** = Entry point (HTTP layer)
3. **Service** = Business logic ("show once" rule)
4. **Proxy** = External calls (AI service)
5. **Repository** = Database access
6. **Entity** = Database table representation
7. **SQL Script** = Database schema

**The Flow:**
```
HTTP Request â†’ Controller â†’ Service â†’ [Check DB]
                                      â”œâ”€ Already shown? â†’ Return null
                                      â””â”€ First time? â†’ Call AI â†’ Save DB â†’ Return suggestions
```

---

ğŸ‰ **Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù€ Implementation Ø§Ù„ÙƒØ§Ù…Ù„!**
